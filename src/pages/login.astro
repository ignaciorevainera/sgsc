---
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";

const supabase = createAstroSupabase(Astro);

// Si ya estás logueado, redirigir al Admin
const {
  data: { session },
} = await supabase.auth.getSession();
if (session) {
  return Astro.redirect("/admin");
}

let errorMessage = "";

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const email = formData.get("email")?.toString();
    const password = formData.get("password")?.toString();

    if (!email || !password) throw new Error("Datos incompletos.");

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) throw new Error("Email o contraseña incorrectos.");

    return Astro.redirect("/admin");
  } catch (err: any) {
    errorMessage = err.message;
  }
}
---

<Main title="Acceso Admin | SGSC">
  <Title title="Acceso Admin" subtitle="Solo personal autorizado" />

  <div class="mx-auto w-full max-w-sm">
    <div class="card bg-base-100 border-base-200 rounded-xl border shadow-md">
      <div class="card-body p-5 sm:p-8">
        {/* Icono decorativo */}
        <div class="mb-4 flex justify-center sm:mb-6">
          <div class="avatar placeholder">
            <div
              class="bg-primary text-primary-content flex w-14 items-center justify-center rounded-full shadow-md sm:w-16"
            >
              <Icon name="material-symbols:lock" size={28} />
            </div>
          </div>
        </div>

        {/* Alerta de error */}
        {
          errorMessage && (
            <div
              role="alert"
              class="alert alert-error mb-4 rounded-xl py-2 text-xs shadow-md sm:text-sm"
            >
              <Icon name="material-symbols:error" class="shrink-0" size={16} />
              <span>{errorMessage}</span>
            </div>
          )
        }

        <form method="POST" class="space-y-3 sm:space-y-4">
          <div class="form-control">
            <label for="email" class="label sr-only">Correo electrónico</label>
            <div class="input validator rounded-xl">
              <Icon
                name="material-symbols:mail"
                class="opacity-50"
                size={18}
                aria-hidden="true"
              />
              <input
                type="email"
                name="email"
                id="email"
                class="grow text-sm sm:text-base"
                placeholder="admin@sgsc.com"
                required
                autocomplete="email"
                aria-describedby="email-hint"
              />
            </div>
            <div id="email-hint" class="validator-hint hidden">
              Ingrese un correo electrónico válido
            </div>
          </div>

          <div class="form-control">
            <label for="password" class="label sr-only">Contraseña</label>
            <div class="input validator rounded-xl">
              <Icon
                name="material-symbols:key"
                class="opacity-50"
                size={18}
                aria-hidden="true"
              />
              <input
                type="password"
                name="password"
                id="password"
                class="grow text-sm sm:text-base"
                placeholder="Contraseña"
                required
                autocomplete="current-password"
              />
            </div>
          </div>

          <div class="form-control mt-6 sm:mt-8">
            <button class="btn btn-primary btn-sm sm:btn-md w-full rounded-xl">
              Ingresar
              <Icon name="material-symbols:login" size={18} />
            </button>
          </div>
        </form>

        <div class="divider mt-6 mb-0 text-xs opacity-30 sm:mt-8 sm:text-xs">
          SGSC V1.0
        </div>
      </div>
    </div>

    <div class="mt-6 text-center sm:mt-8">
      <a
        href="/"
        class="btn btn-ghost btn-xs sm:btn-sm rounded-xl opacity-50 hover:opacity-100"
      >
        <Icon name="material-symbols:arrow-back" size={16} /> Volver al inicio
      </a>
    </div>
  </div>
</Main>
