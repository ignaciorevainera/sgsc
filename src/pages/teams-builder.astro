---
import { createAstroSupabase } from "@/lib/supabase";
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";
import Card from "@/components/shared/Card.astro";
import { Icon } from "astro-icon/components";
import PlayerSelectCard from "@/components/teams/PlayerSelectCard.astro";
import ActionBar from "@/components/teams/ActionBar.astro";

const supabase = createAstroSupabase(Astro);

// 1. Obtenemos TODOS los jugadores
const { data: allPlayers } = await supabase
  .from("view_player_stats_all_time")
  .select("player_id, nickname, win_pct, matches_played, points, is_guest");

// 2. FILTRADO - Excluimos "amigo de X"
const filteredPlayers =
  allPlayers?.filter((p) => !p.nickname.toLowerCase().includes("amigo de")) ||
  [];

// 3. ORDENAMIENTO - Socios primero, luego alfab√©tico
const sortedPlayers = filteredPlayers.sort((a, b) => {
  if (a.is_guest !== b.is_guest) return a.is_guest ? 1 : -1;
  return a.nickname.localeCompare(b.nickname);
});

// 4. Mapeo de datos para el cliente
const playersData = sortedPlayers.map((p) => ({
  id: p.player_id,
  name: p.nickname,
  rating: p.matches_played > 3 ? p.win_pct : 50,
  isGuest: p.is_guest,
}));

// Contadores
const totalPlayers = playersData.length;
const guestPlayers = playersData.filter((p) => p.isGuest).length;
const clubPlayers = totalPlayers - guestPlayers;
---

<Main title="Armador de Equipos | SGSC">
  <Title
    title="Armador de Equipos"
    subtitle="Selecciona a los convocados y arma equipos balanceados"
  />

  <div id="squad-builder" class="relative space-y-6">
    {/* Header Sticky con Controles */}
    <Card
      class="bg-base-100/95 sticky top-22 z-30 backdrop-blur-md"
      bodyClass="p-2 sm:p-3"
    >
      <div class="grid grid-cols-3 place-items-center gap-2">
        {/* Contador Total Seleccionados (Socios + Invitados) */}
        <div class="flex items-center gap-2">
          <div
            class="badge badge-primary badge-lg rounded-xl font-black shadow-sm transition-all duration-200 sm:text-lg"
            id="counter-badge"
          >
            0
          </div>
          <div class="hidden flex-col leading-tight sm:flex">
            <span
              class="text-base-content/50 text-xs font-bold tracking-widest uppercase"
            >
              Convocados
            </span>
          </div>
        </div>

        {/* Contador Invitados - Compacto */}
        <div
          class="bg-base-200/60 grid grid-cols-3 grid-rows-2 place-items-center rounded-xl px-4 py-1.5"
        >
          <button
            id="guest-minus"
            class="btn btn-ghost btn-xs btn-square hover:bg-base-300 rounded-lg transition-colors"
            aria-label="Quitar invitado"
          >
            <Icon name="material-symbols:remove" size={16} />
          </button>
          <div class="flex flex-col items-center leading-none select-none">
            <span
              class="text-base font-black sm:text-lg"
              id="guest-counter-display">0</span
            >
          </div>
          <button
            id="guest-plus"
            class="btn btn-ghost btn-xs btn-square hover:bg-base-300 rounded-lg transition-colors"
            aria-label="Agregar invitado"
          >
            <Icon name="material-symbols:add" size={16} />
          </button>
          <span
            class="text-base-content/50 col-span-3 text-xs font-bold tracking-widest uppercase"
          >
            Invitados
          </span>
        </div>

        {/* Bot√≥n Reset */}
        <button
          id="reset-btn"
          class="btn btn-error btn-xs btn-disabled sm:btn-sm gap-1 rounded-xl transition-all duration-200"
          aria-label="Limpiar selecci√≥n"
        >
          <Icon name="material-symbols:refresh" size={16} />
          <span class="hidden text-xs font-bold uppercase sm:inline">Reset</span
          >
        </button>
      </div>
    </Card>

    {/* Stats R√°pidas */}
    <div
      class="text-base-content/50 flex justify-center gap-4 text-xs font-bold tracking-wider uppercase"
    >
      <span>{clubPlayers} Socios</span>
      <span class="opacity-30">‚Ä¢</span>
      <span>{guestPlayers} Invitados</span>
    </div>

    {/* Grid de Jugadores */}
    <div
      class="mb-10 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6"
    >
      {
        playersData.map((player) => (
          <PlayerSelectCard
            id={player.id}
            name={player.name}
            rating={player.rating}
            isGuest={player.isGuest}
          />
        ))
      }
    </div>

    {/* Secci√≥n Resultados - Se muestra al generar equipos */}
    <section id="teams-result" class="mb-8 hidden space-y-4">
      {/* Divider con t√≠tulo */}
      <div class="divider">
        <span
          class="text-base-content/50 text-xs font-bold tracking-widest uppercase"
        >
          Equipos Generados
        </span>
      </div>

      {/* Contenedor de Equipos */}
      <div
        class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6"
        id="teams-container"
      >
      </div>

      <div class="flex flex-col items-center justify-center gap-3">
        {/* Diferencia */}
        <div
          class="badge badge-neutral badge-lg gap-2 rounded-xl font-bold uppercase"
        >
          <span class="opacity-50">Diferencia:</span>
          <span id="diff-display" class="text-lg font-black">0%</span>
        </div>

        {/* Bot√≥n Compartir */}
        <button
          id="copy-btn"
          class="btn btn-success gap-2 rounded-xl font-bold tracking-wider text-white uppercase shadow-md transition-all duration-200 hover:scale-[1.02]"
        >
          <Icon name="material-symbols:share" size={20} />
          Compartir en WhatsApp
        </button>
      </div>
    </section>
  </div>

  {/* Action Bar (fixed bottom) */}
  <ActionBar />
</Main>

<script is:inline define:vars={{ playersData }}>
  /* L√ìGICA DEL CLIENTE */
  let selectedIds = new Set();
  let guestCount = 0;
  const playerMap = new Map(playersData.map((p) => [String(p.id), p]));

  // DOM Elements
  const cards = document.querySelectorAll(".player-card");
  const counterBadge = document.getElementById("counter-badge");
  const totalCounterBadge = document.getElementById("total-counter-badge");
  const totalCounter = document.getElementById("total-counter");
  const guestDisplay = document.getElementById("guest-counter-display");
  const actionBar = document.getElementById("action-bar");
  const resetBtn = document.getElementById("reset-btn");
  const generateBtn = document.getElementById("generate-btn");
  const teamsResult = document.getElementById("teams-result");
  const teamsContainer = document.getElementById("teams-container");

  // Selecci√≥n de Jugadores
  cards.forEach((card) => {
    // Click
    card.addEventListener("click", () => toggleSelection(card));

    // Teclado (Enter/Space)
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleSelection(card);
      }
    });
  });

  function toggleSelection(card) {
    const id = String(card.dataset.id);

    // Haptic Feedback
    if (navigator.vibrate) navigator.vibrate(10);

    if (selectedIds.has(id)) {
      selectedIds.delete(id);
      delete card.dataset.selected;
      card.setAttribute("aria-checked", "false");
    } else {
      selectedIds.add(id);
      card.dataset.selected = "";
      card.setAttribute("aria-checked", "true");
    }

    updateUI();
  }

  // Invitados Manuales
  document.getElementById("guest-plus")?.addEventListener("click", () => {
    guestCount++;
    updateUI();
  });

  document.getElementById("guest-minus")?.addEventListener("click", () => {
    if (guestCount > 0) {
      guestCount--;
      updateUI();
    }
  });

  // Reset
  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      selectedIds.clear();
      guestCount = 0;
      cards.forEach((c) => {
        delete c.dataset.selected;
        c.setAttribute("aria-checked", "false");
      });
      // Ocultar resultados
      if (teamsResult) {
        teamsResult.classList.add("hidden");
      }
      updateUI();
    });
  }

  function updateUI() {
    const selectedCount = selectedIds.size;
    const total = selectedCount + guestCount;
    const minPlayers = parseInt(actionBar?.dataset.minPlayers || "10");

    // Actualizar contador principal (total = socios + invitados)
    if (counterBadge) {
      counterBadge.textContent = total;
      counterBadge.classList.add("scale-110");
      setTimeout(() => counterBadge.classList.remove("scale-110"), 150);

      // Cambiar color seg√∫n progreso
      if (total >= minPlayers) {
        counterBadge.classList.remove("bg-base-300", "text-base-content");
        counterBadge.classList.add("bg-primary", "text-primary-content");
      } else {
        counterBadge.classList.remove("bg-primary", "text-primary-content");
        counterBadge.classList.add("bg-base-300", "text-base-content");
      }
    }

    if (guestDisplay) guestDisplay.textContent = guestCount;

    if (totalCounter) totalCounter.textContent = total;
    if (totalCounterBadge) {
      totalCounterBadge.textContent = total;
      // Cambiar color seg√∫n progreso
      if (total >= minPlayers) {
        totalCounterBadge.classList.remove("bg-base-300", "text-base-content");
        totalCounterBadge.classList.add("bg-primary", "text-primary-content");
      } else {
        totalCounterBadge.classList.remove(
          "bg-primary",
          "text-primary-content",
        );
        totalCounterBadge.classList.add("bg-base-300", "text-base-content");
      }
    }

    // Habilitar/deshabilitar bot√≥n seg√∫n m√≠nimo
    if (generateBtn) {
      generateBtn.disabled = total < minPlayers;
    }

    // Mostrar/ocultar bot√≥n reset
    if (resetBtn) {
      if (total > 0) {
        resetBtn.classList.remove("btn-disabled");
      } else {
        resetBtn.classList.add("btn-disabled");
      }
    }
  }

  // Generar Equipos
  if (generateBtn) {
    generateBtn.addEventListener("click", () => {
      const total = selectedIds.size + guestCount;
      const minPlayers = parseInt(actionBar?.dataset.minPlayers || "10");

      if (total < minPlayers) {
        alert(`¬°Se necesitan al menos ${minPlayers} jugadores!`);
        return;
      }

      // Pool de jugadores
      let pool = Array.from(selectedIds)
        .map((id) => playerMap.get(id))
        .filter((p) => p !== undefined);

      // Agregar invitados an√≥nimos
      for (let i = 1; i <= guestCount; i++) {
        pool.push({
          id: `guest-${i}`,
          name: `Invitado ${i}`,
          rating: 50,
          isGuest: true,
          isAnonymous: true,
        });
      }

      // Ordenar por rating (mejor primero)
      pool.sort((a, b) => b.rating - a.rating);

      // Algoritmo de balanceo greedy
      const teamA = {
        name: "Equipo Claro",
        type: "light",
        players: [],
        sum: 0,
      };
      const teamB = {
        name: "Equipo Oscuro",
        type: "dark",
        players: [],
        sum: 0,
      };

      pool.forEach((p) => {
        if (teamA.sum <= teamB.sum) {
          teamA.players.push(p);
          teamA.sum += p.rating;
        } else {
          teamB.players.push(p);
          teamB.sum += p.rating;
        }
      });

      renderResult(teamA, teamB);

      // Mostrar secci√≥n de resultados y hacer scroll
      if (teamsResult) {
        teamsResult.classList.remove("hidden");
        teamsResult.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  }

  function renderResult(t1, t2) {
    if (!teamsContainer) return;

    const avg1 = t1.players.length ? Math.round(t1.sum / t1.players.length) : 0;
    const avg2 = t2.players.length ? Math.round(t2.sum / t2.players.length) : 0;
    const diff = Math.abs(avg1 - avg2);

    // Actualizar indicador de diferencia
    const diffEl = document.getElementById("diff-display");
    if (diffEl) {
      diffEl.textContent = `${diff}%`;
      diffEl.className = `text-lg font-black ${diff < 5 ? "text-success" : diff < 10 ? "text-warning" : "text-error"}`;
    }

    // Estilos por tipo de equipo
    const getTeamClasses = (type) => {
      if (type === "light") {
        return {
          container: "bg-slate-50 border-slate-200",
          header: "bg-slate-100 border-b border-slate-200",
          headerText: "text-slate-700",
          item: "bg-white border-slate-100 text-slate-700",
          avg: "bg-slate-200 text-slate-600",
          avatar: "bg-slate-200 text-slate-600",
          icon: "bg-slate-200 border-slate-300",
        };
      }
      return {
        container: "bg-slate-800 border-slate-700",
        header: "bg-slate-900 border-b border-slate-700",
        headerText: "text-slate-100",
        item: "bg-slate-700 border-slate-600 text-slate-200",
        avg: "bg-slate-600 text-slate-300",
        avatar: "bg-slate-600 text-slate-300",
        icon: "bg-slate-700 border-slate-600",
      };
    };

    const createTeamHTML = (team, avg) => {
      const s = getTeamClasses(team.type);
      const isLight = team.type === "light";

      return `
        <div class="${s.container} flex flex-col overflow-hidden rounded-xl border shadow-md">
          <div class="${s.header} ${s.headerText} flex items-center justify-between p-3 sm:p-4">
            <div class="flex items-center gap-2">
              <svg class="size-5 ${isLight ? "text-amber-500" : "text-slate-400"}" viewBox="0 0 24 24" fill="currentColor">
                ${
                  isLight
                    ? '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 0 0 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>'
                    : '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>'
                }
              </svg>
              <span class="text-sm font-black uppercase tracking-wider">${team.name}</span>
            </div>
            <span class="${s.avg} rounded-lg px-2 py-1 text-xs font-bold uppercase tracking-wider">${avg}% AVG</span>
          </div>
          <ul class="flex-1 space-y-1 p-2">
            ${team.players
              .map(
                (p) => `
                <li class="${s.item} flex items-center gap-3 rounded-lg border p-2">
                  <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content flex w-8 items-center justify-center rounded-full text-xs font-black ring-2 ${isLight ? "ring-slate-200" : "ring-slate-600"} ring-offset-1 ${isLight ? "ring-offset-white" : "ring-offset-slate-700"}">
                      ${p.isAnonymous ? "?" : p.name.charAt(0)}
                    </div>
                  </div>
                  <span class="flex-1 text-xs font-bold uppercase tracking-wide ${p.isGuest ? "italic opacity-70" : ""}">${p.name}</span>
                  ${p.isGuest ? '<span class="badge badge-warning badge-xs text-xs font-bold">INV</span>' : ""}
                </li>
              `,
              )
              .join("")}
          </ul>
        </div>
      `;
    };

    teamsContainer.innerHTML = `
      <div class="contents">
        ${createTeamHTML(t1, avg1)}
      </div>
      <div class="flex items-center justify-center md:hidden">
        <div class="bg-base-100 border-base-200 rounded-full border px-3 py-1 text-xs font-black uppercase tracking-widest opacity-60 shadow-sm">VS</div>
      </div>
      <div class="contents">
        ${createTeamHTML(t2, avg2)}
      </div>
    `;

    // Texto para WhatsApp
    const pageUrl = window.location.href;
    window.whatsappText =
      `‚öΩ *PARTIDO ARMADO* ‚öΩ\n\n` +
      `‚òÄÔ∏è *CLARO (${avg1}%)*\n${t1.players.map((p) => `‚Ä¢ ${p.name}`).join("\n")}\n\n` +
      `üåô *OSCURO (${avg2}%)*\n${t2.players.map((p) => `‚Ä¢ ${p.name}`).join("\n")}\n\n` +
      `‚öñÔ∏è _Diferencia: ${diff}%_\n` +
      `Link: ${pageUrl}\n` +
      `üì≤ Generado con SGSC App`;
  }

  // Copiar/Compartir
  const copyBtn = document.getElementById("copy-btn");
  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      if (!window.whatsappText) return;

      try {
        await navigator.clipboard.writeText(window.whatsappText);

        // Feedback visual
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `<span class="flex items-center gap-2">‚úì ¬°Copiado!</span>`;
        copyBtn.classList.replace("btn-success", "btn-neutral");

        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.classList.replace("btn-neutral", "btn-success");
        }, 2000);
      } catch (err) {
        console.error("Error al copiar:", err);
      }
    });
  }
</script>
