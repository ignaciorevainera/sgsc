---
import { Icon } from "astro-icon/components";
import { supabase } from "../lib/supabase";
import Alert from "@/components/shared/Alert.astro";
import Avatar from "@/components/Avatar.astro";
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";

// 1. Datos
const { data: players, error } = await supabase
  .from("view_player_stats_all_time")
  .select("*")
  .eq("is_guest", false);

const hasError = !!error;
const safePlayers = players || [];

// 2. Helper Top 5
const getTop5 = (filterFn: any, sortFn: any) => {
  return [...safePlayers].filter(filterFn).sort(sortFn).slice(0, 5);
};

// 3. Generar Categor칤as

// A. Puntos (Leyendas)
const topPoints = getTop5(
  () => true,
  (a: any, b: any) => b.points - a.points || b.win_pct - a.win_pct,
);

// B. Efectividad (Min 5 PJ)
const topWinRate = getTop5(
  (p: any) => p.matches_played >= 5,
  (a: any, b: any) => b.win_pct - a.win_pct || b.points - a.points,
);

// C. Victorias
const topWins = getTop5(
  () => true,
  (a: any, b: any) => b.wins - a.wins || b.win_pct - a.win_pct,
);

// D. Presencia (% Asistencia sobre total de partidos) - NUEVA SOLICITADA
// Nota: 'attendance_pct' viene de la vista SQL
const topAttendancePct = getTop5(
  () => true,
  (a: any, b: any) =>
    b.attendance_pct - a.attendance_pct || b.matches_played - a.matches_played,
);

// E. Cantidad de Partidos (El Hist칩rico)
const topMatches = getTop5(
  () => true,
  (a: any, b: any) => b.matches_played - a.matches_played,
);

// F. Empates (El Diplom치tico)
const topDraws = getTop5(
  () => true,
  (a: any, b: any) => b.draws - a.draws || b.matches_played - a.matches_played,
);

// G. Derrotas (El Resiliente - Quien m치s perdi칩 pero sigue jugando)
const topLosses = getTop5(
  () => true,
  (a: any, b: any) =>
    b.losses - a.losses || b.matches_played - a.matches_played,
);

// H. Muro Defensivo (Menos derrotas con Min 10 PJ)
const topUndefeated = getTop5(
  (p: any) => p.matches_played >= 10,
  (a: any, b: any) =>
    a.losses - b.losses || b.matches_played - a.matches_played,
);

const currentYear = new Date().getFullYear();
const lastSeason = currentYear - 1;

// 1. Buscamos los datos de la temporada pasada
const { data: championsData } = await supabase
  .from("view_player_stats_yearly")
  .select("player_id, nickname, points, win_rate")
  .eq("year", lastSeason)
  .eq("is_guest", false) // Solo socios pueden ser campeones
  .order("points", { ascending: false })
  .order("win_rate", { ascending: false });

// 2. Manejamos posibles empates en el primer puesto
const topPointsChampions = championsData?.[0]?.points;
const champions =
  championsData?.filter((p) => p.points === topPointsChampions) || [];

const { data: allMatchPlayers } = await supabase.from("match_players").select(`
    match_id,
    player_id,
    team,
    player:players(nickname, is_guest),
    match:matches(result)
  `);

const teamsByMatch = new Map();
const duoStats = new Map();

// 1. Agrupamos por partido y por equipo
allMatchPlayers?.forEach((entry) => {
  // Verificaci칩n de arrays por si Supabase devuelve listas
  // @ts-ignore
  const player = Array.isArray(entry.player) ? entry.player[0] : entry.player;
  // @ts-ignore
  const match = Array.isArray(entry.match) ? entry.match[0] : entry.match;

  if (player?.is_guest) return;

  const key = `${entry.match_id}-${entry.team}`;
  if (!teamsByMatch.has(key)) {
    teamsByMatch.set(key, {
      players: [],
      // Normalizamos texto para evitar errores de may칰sculas/espacios
      result: match?.result ? match.result.toLowerCase().trim() : "",
      team: entry.team ? entry.team.toLowerCase().trim() : "",
    });
  }

  teamsByMatch.get(key).players.push({
    id: entry.player_id,
    nickname: player?.nickname || "Desconocido",
  });
});

// 2. Calculamos estad칤sticas de cada par
teamsByMatch.forEach((val) => {
  if (val.players.length >= 2) {
    // Recorremos todas las combinaciones posibles de compa침eros
    for (let i = 0; i < val.players.length; i++) {
      for (let j = i + 1; j < val.players.length; j++) {
        const p1 = val.players[i];
        const p2 = val.players[j];

        // Llave 칰nica ordenada por ID (para que A-B sea igual a B-A)
        const pairKey = [p1.id, p2.id].sort().join("-");

        if (!duoStats.has(pairKey)) {
          duoStats.set(pairKey, {
            names: `${p1.nickname} & ${p2.nickname}`,
            matches: 0,
            wins: 0,
            player1: p1, // Guardamos referencia para los avatares
            player2: p2,
          });
        }

        const stats = duoStats.get(pairKey);
        stats.matches++;

        // Sumamos victoria SOLO si ganaron y no fue empate
        if (val.result === val.team && val.result !== "draw") {
          stats.wins++;
        }
      }
    }
  }
});

// 3. Generar terna final con porcentaje real
const topDuosData = [...duoStats.values()]
  .filter((d) => d.matches >= 3)
  .map((d) => ({
    nickname: d.names,
    // Usamos win_rate como llave num칠rica para el sort
    win_rate: Math.round((d.wins / d.matches) * 100),
    matches_played: d.matches,
    is_duo: true,
    player1: d.player1,
    player2: d.player2,
  }))
  .sort(
    (a, b) => b.win_rate - a.win_rate || b.matches_played - a.matches_played,
  )
  .slice(0, 5);

// Configuraci칩n de Categor칤as con colores DaisyUI est치ndar
const categories = [
  {
    title: "Leyenda Absoluta",
    subtitle: "Mayor cantidad de Puntos",
    icon: "material-symbols:trophy",
    color: "text-warning",
    bg: "bg-warning",
    gradient: "from-warning/10 to-transparent",
    data: topPoints,
    valueKey: "points",
    suffix: "PTS",
  },
  {
    title: "El Talism치n",
    subtitle: "Mayor % Efectividad (Min 5 PJ)",
    icon: "material-symbols:trending-up",
    color: "text-success",
    bg: "bg-success",
    gradient: "from-success/10 to-transparent",
    data: topWinRate,
    valueKey: "win_pct",
    suffix: "%",
  },
  {
    title: "Asistencia Perfecta",
    subtitle: "Mayor % de Presencia en Partidos",
    icon: "material-symbols:event-available",
    color: "text-info",
    bg: "bg-info",
    gradient: "from-info/10 to-transparent",
    data: topAttendancePct,
    valueKey: "attendance_pct",
    suffix: "%",
  },
  {
    title: "El Ganador",
    subtitle: "M치s partidos ganados",
    icon: "material-symbols:verified",
    color: "text-primary",
    bg: "bg-primary",
    gradient: "from-primary/10 to-transparent",
    data: topWins,
    valueKey: "wins",
    suffix: "Triunfos",
  },
  {
    title: "El Hist칩rico",
    subtitle: "M치s partidos jugados",
    icon: "material-symbols:calendar-month",
    color: "text-accent",
    bg: "bg-accent",
    gradient: "from-accent/10 to-transparent",
    data: topMatches,
    valueKey: "matches_played",
    suffix: "Partidos",
  },
  {
    title: "El Diplom치tico",
    subtitle: "Rey del Empate",
    icon: "material-symbols:handshake",
    color: "text-slate-500",
    bg: "bg-slate-500",
    gradient: "from-slate-500/20 to-transparent",
    data: topDraws,
    valueKey: "draws",
    suffix: "Empates",
  },
  {
    title: "Muro Defensivo",
    subtitle: "Menos Derrotas (Min 10 PJ)",
    icon: "material-symbols:shield",
    color: "text-secondary",
    bg: "bg-secondary",
    gradient: "from-secondary/10 to-transparent",
    data: topUndefeated,
    valueKey: "losses",
    suffix: "Derrotas",
  },
  {
    title: "El Resiliente",
    subtitle: "M치s derrotas sufridas",
    icon: "material-symbols:sentiment-very-dissatisfied",
    color: "text-error",
    bg: "bg-error",
    gradient: "from-error/10 to-transparent",
    data: topLosses,
    valueKey: "losses",
    suffix: "Ca칤das",
  },
];
---

<Main title="Sal칩n de la Fama | SGSC">
  <div class="mb-8 text-center">
    <div
      class="bg-warning/10 mb-4 inline-flex items-center justify-center rounded-full p-4 shadow-md"
    >
      <Icon
        name="material-symbols:workspace-premium"
        class="text-warning size-10 sm:size-12"
      />
    </div>

    <Title
      title="Sal칩n de la Fama"
      subtitle="Jugadores legendarios y r칠cords hist칩ricos del club."
    />
  </div>

  {/* Error de conexi칩n */}
  {
    hasError && (
      <Alert
        type="error"
        message="No se pudo cargar el Sal칩n de la Fama. Por favor, intenta m치s tarde."
      />
    )
  }

  {/* Sin datos */}
  {
    !hasError && safePlayers.length === 0 && (
      <Alert
        type="info"
        message="A칰n no hay suficientes datos para mostrar el Sal칩n de la Fama."
      />
    )
  }

  {
    champions.length > 0 && (
      <div class="card border-warning/30 from-warning/10 via-base-100 to-base-100 mb-8 border-2 bg-linear-to-br shadow-lg">
        <div class="card-body flex flex-col items-center py-10 text-center">
          <div class="bg-warning shadow-warning/20 mb-6 flex h-20 w-20 items-center justify-center rounded-full shadow-lg">
            <Icon
              name="material-symbols:trophy"
              size={48}
              class="text-base-100"
            />
          </div>

          <h2 class="text-warning text-sm font-black tracking-widest text-balance uppercase">
            Campe칩n Temporada {lastSeason}
          </h2>

          <div class="mt-6 flex flex-col items-center gap-8 sm:flex-row sm:flex-wrap sm:justify-center">
            {champions.map((champ) => (
              <div class="flex flex-col items-center">
                <span class="text-4xl font-black italic sm:text-5xl">
                  {champ.nickname.toUpperCase()}
                </span>
                <div class="text-base-content/60 mt-3 flex items-center gap-2 text-xs font-bold uppercase sm:text-sm">
                  <span>{champ.points} pts</span>
                  <span class="h-1 w-1 rounded-full bg-current" />
                  <span>{Math.round(champ.win_rate)}% w-rate</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    )
  }

  {
    !hasError && safePlayers.length > 0 && (
      <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">
        {categories.map((cat) => {
          const leader = cat.data[0];
          const followers = cat.data.slice(1);

          if (!leader) return null;

          return (
            <div class="card border-base-200 bg-base-100 flex h-full flex-col overflow-hidden rounded-xl border shadow-md">
              <div
                class={`border-base-200/50 relative flex flex-col items-center border-b bg-linear-to-b ${cat.gradient} grow px-6 py-8 text-center`}
              >
                <div class="absolute top-4 right-4 opacity-20">
                  <Icon
                    name={cat.icon}
                    class={`size-10 sm:size-12 ${cat.color}`}
                  />
                </div>

                <div class="mb-4 animate-bounce text-3xl sm:text-4xl">游녬</div>

                <a href={`/players/${leader.player_id}`}>
                  <Avatar
                    initial={leader.nickname.charAt(0).toUpperCase()}
                    ring={true}
                  />

                  <h2 class="text-base-content mt-4 text-xl font-black tracking-tight sm:text-2xl">
                    {leader.nickname}
                  </h2>
                </a>

                <div
                  class={`badge badge-lg text-base-100 mt-3 rounded-xl border-none font-bold ${cat.bg}`}
                >
                  {leader[cat.valueKey]} {cat.suffix}
                </div>

                <p
                  class={`mt-4 text-xs font-bold tracking-widest text-balance uppercase ${cat.color}`}
                >
                  {cat.subtitle}
                </p>
              </div>

              <div class="bg-base-100">
                {followers.map((player, index) => (
                  <a
                    href={`/players/${player.player_id}`}
                    class="group border-base-200/50 hover:bg-base-200 flex items-center justify-between border-b px-4 py-3 transition-colors last:border-0"
                  >
                    <div class="flex items-center gap-3">
                      <span class="text-base-content/50 w-6 text-center text-xs font-bold uppercase">
                        #{index + 2}
                      </span>

                      <Avatar
                        initial={player.nickname.charAt(0).toUpperCase()}
                        size="sm"
                        interactive={true}
                      />

                      <span class="group-hover:text-primary text-sm font-semibold transition-colors">
                        {player.nickname}
                      </span>
                    </div>

                    <div class="text-right text-sm font-bold">
                      <span>{player[cat.valueKey]}</span>
                      <span class="text-base-content/60 text-xs font-normal">
                        {cat.suffix
                          .replace("Triunfos", "G")
                          .replace("Partidos", "PJ")
                          .replace("Empates", "E")
                          .replace("Derrotas", "D")
                          .replace("Ca칤das", "D")}
                      </span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          );
        })}

        {/* Card de Mejor Dupla - Color verde (success) */}
        <div class="card border-base-200 bg-base-100 flex h-full flex-col overflow-hidden rounded-xl border shadow-md">
          <div class="border-base-200/50 from-success/10 relative flex flex-col items-center border-b bg-linear-to-b to-transparent px-6 py-8 text-center">
            <div class="absolute top-4 right-4 opacity-20">
              <Icon
                name="material-symbols:group-add"
                class="text-success size-10 sm:size-12"
              />
            </div>

            <div class="mb-4 animate-bounce text-3xl sm:text-4xl">游뱋</div>

            {topDuosData.length > 0 ? (
              <>
                <div class="flex -space-x-3">
                  <a href={`/players/${topDuosData[0].player1.id}`}>
                    <Avatar
                      initial={topDuosData[0].player1.nickname
                        .charAt(0)
                        .toUpperCase()}
                      ring={true}
                    />
                  </a>
                  <a href={`/players/${topDuosData[0].player2.id}`}>
                    <Avatar
                      initial={topDuosData[0].player2.nickname
                        .charAt(0)
                        .toUpperCase()}
                      ring={true}
                    />
                  </a>
                </div>

                <h2 class="text-base-content mt-4 text-xl font-black tracking-tight sm:text-2xl">
                  {topDuosData[0].nickname}
                </h2>

                <div class="badge badge-lg text-base-100 bg-success mt-3 rounded-xl border-none font-bold">
                  {topDuosData[0].win_rate}% Efectividad
                </div>

                <p class="text-success mt-4 text-xs font-bold tracking-widest text-balance uppercase">
                  Mejor Dupla (Min 3 PJ)
                </p>
              </>
            ) : (
              <p class="text-base-content/50 text-sm">
                No hay duplas con suficientes partidos
              </p>
            )}
          </div>

          <div class="bg-base-100 flex grow flex-col">
            {topDuosData.slice(1).map((duo, index) => (
              <div class="group border-base-200/50 hover:bg-base-200 flex flex-1 items-center justify-between border-b px-4 py-3 transition-colors last:border-0">
                <div class="flex items-center gap-3">
                  <span class="text-base-content/50 w-6 text-center text-xs font-bold uppercase">
                    #{index + 2}
                  </span>

                  <div class="flex -space-x-2">
                    <a href={`/players/${duo.player1.id}`}>
                      <Avatar
                        initial={duo.player1.nickname.charAt(0).toUpperCase()}
                        size="xs"
                        interactive={true}
                      />
                    </a>
                    <a href={`/players/${duo.player2.id}`}>
                      <Avatar
                        initial={duo.player2.nickname.charAt(0).toUpperCase()}
                        size="xs"
                        interactive={true}
                      />
                    </a>
                  </div>

                  <span class="group-hover:text-success text-sm font-semibold transition-colors">
                    {duo.nickname}
                  </span>
                </div>

                <div class="text-right text-sm font-bold">
                  <span>{duo.win_rate}</span>
                  <span class="text-base-content/60 text-xs font-normal">
                    %
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    )
  }
</Main>
