---
import Main from "@/layouts/Main.astro";
import { Icon } from "astro-icon/components";
import Avatar from "@/components/Avatar.astro";
import SectionTitle from "@/components/shared/SectionTitle.astro";
import Alert from "@/components/shared/Alert.astro";
import { createAstroSupabase } from "@/lib/supabase";

import { formatDate, calculateAge } from "@/lib/utils/dateUtils";

const supabase = createAstroSupabase(Astro);
const { id } = Astro.params;

if (!id) return Astro.redirect("/players");

const { data: playerInfo, error: playerInfoError } = await supabase
  .from("players")
  .select("birth_date, nickname, preferred_foot")
  .eq("id", id)
  .single();

// Si hay error de conexión o jugador no existe, redirigir
if (playerInfoError || !playerInfo) return Astro.redirect("/players");

// 2. Estadísticas de carrera (Vista All Time)
const { data: playerStats } = await supabase
  .from("view_player_stats_all_time")
  .select("*")
  .eq("player_id", id)
  .single();

if (!playerStats) return Astro.redirect("/players");

const player = { ...playerInfo, ...playerStats };

// 3. Estadísticas por Año
const { data: yearlyStats } = await supabase
  .from("view_player_stats_yearly")
  .select("*")
  .eq("player_id", id)
  .order("year", { ascending: false });

// 4. Promedio del club
const { data: allStats } = await supabase
  .from("view_player_stats_all_time")
  .select("win_pct");

const clubAverageWinPct = allStats
  ? Math.round(
      allStats.reduce((acc, s) => acc + s.win_pct, 0) / allStats.length
    )
  : 0;

// 5. Historial completo
const { data: allHistory } = await supabase
  .from("match_players")
  .select(
    `
    team,
    matches!inner (
      date,
      result,
      fields (name)
    )
  `
  )
  .eq("player_id", id)
  .order("matches(date)", { ascending: false });

// --- CÁLCULOS ---
const totalMatches = player.matches_played || 0;
const win_pct = Math.round(player.win_pct || 0);
const draw_pct =
  totalMatches > 0 ? Math.round((player.draws / totalMatches) * 100) : 0;
const loss_pct =
  totalMatches > 0 ? Math.round((player.losses / totalMatches) * 100) : 0;

const light_apps =
  allHistory?.filter((m: any) => m.team === "light").length || 0;
const dark_apps = allHistory?.filter((m: any) => m.team === "dark").length || 0;

// Sede
const fieldCounts: Record<string, number> = {};
allHistory?.forEach((m: any) => {
  const name = m.matches?.fields?.name;
  if (name) fieldCounts[name] = (fieldCounts[name] || 0) + 1;
});
const topField =
  Object.entries(fieldCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";

// --- TRADUCCIÓN PIERNA DOMINANTE (Nueva Lógica) ---
const footMap: Record<string, string> = {
  right: "Diestro",
  left: "Zurdo",
  both: "Ambidiestro",
};
// Esto nos da directamente el texto en español listo para usar en la vista
const dominantFootLabel = player.preferred_foot
  ? footMap[player.preferred_foot]
  : null;

// Últimos 5 partidos
const recentMatches = allHistory?.slice(0, 5).map((mp: any) => {
  const m = mp.matches;
  let outcome = "L";
  if (m.result === "draw") outcome = "D";
  else if (m.result === mp.team) outcome = "W";
  return { date: m.date, fieldName: m.fields?.name, outcome };
});

const getOutcomeConfig = (outcome: string) => {
  const configs: any = {
    W: {
      label: "Victoria",
      color: "text-success",
      bg: "bg-success/10",
      icon: "material-symbols:trophy",
    },
    L: {
      label: "Derrota",
      color: "text-error",
      bg: "bg-error/10",
      icon: "material-symbols:close",
    },
    D: {
      label: "Empate",
      color: "text-warning",
      bg: "bg-warning/10",
      icon: "material-symbols:equal",
    },
  };
  return configs[outcome] || configs.L;
};
---

<Main title={`${player.nickname} | SGSC`}>
  <div
    class="card bg-base-100 border-base-200 mb-8 overflow-hidden rounded-xl border shadow-md"
  >
    <div
      class="from-primary/20 via-base-100 to-secondary/10 relative h-28 bg-gradient-to-r sm:h-32"
    >
      <div
        class="from-base-content absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] to-transparent opacity-10"
      >
      </div>
    </div>

    <div class="card-body relative px-4 py-5 sm:px-6">
      <div
        class="flex flex-col items-center gap-4 sm:flex-row sm:items-start sm:gap-6"
      >
        <div class="-mt-16 sm:-mt-14">
          <Avatar initial={player.nickname.charAt(0).toUpperCase()} size="lg" />
        </div>

        <div class="flex-grow space-y-2 text-center sm:mt-2 sm:text-left">
          <div
            class="flex flex-wrap items-center justify-center gap-2 sm:justify-start sm:gap-3"
          >
            <h1
              class="text-primary text-2xl font-black sm:text-3xl md:text-4xl"
            >
              {player.nickname}
            </h1>
          </div>
          <p
            class="text-base-content/60 font-mono text-[10px] tracking-widest uppercase sm:text-xs"
          >
            ID: {id.split("-")[0]} • Debut: {
              yearlyStats?.[yearlyStats.length - 1]?.year || "-"
            }
          </p>
          <div
            class="flex flex-wrap items-center justify-center gap-2 sm:justify-start"
          >
            {
              player.birth_date && (
                <div class="badge bg-base-content/10 gap-1 rounded-xl border-none text-xs font-semibold">
                  <Icon name="material-symbols:calendar-today" size={12} />
                  {calculateAge(player.birth_date)} años
                </div>
              )
            }
            {
              player.birth_date && (
                <div class="badge bg-base-content/10 gap-1 rounded-xl border-none text-xs font-semibold">
                  <Icon name="material-symbols:cake" size={12} />
                  {formatDate(player.birth_date)}
                </div>
              )
            }
            {
              player.preferred_foot && dominantFootLabel && (
                <div class="badge bg-base-content/10 gap-1 rounded-xl border-none text-xs font-semibold">
                  <Icon name="material-symbols:footprint" size={12} />
                  {dominantFootLabel}
                </div>
              )
            }
          </div>
        </div>

        <div class="w-full sm:w-auto">
          <div
            class="stats bg-base-200 border-base-200 w-full rounded-xl border shadow-md sm:w-auto"
          >
            <div class="stat place-items-center px-6 py-3 sm:px-8">
              <div
                class="stat-title text-[10px] font-bold tracking-wider uppercase sm:text-xs"
              >
                Puntos Históricos
              </div>
              <div class="stat-value text-secondary text-2xl sm:text-3xl">
                {player.points}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <div class="space-y-6 lg:col-span-2">
      <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
        <div
          class="card bg-base-100 border-base-200 rounded-xl border p-4 text-center shadow-md"
        >
          <span class="text-2xl font-black">{totalMatches}</span>
          <span class="text-base-content/60 text-[10px] font-bold uppercase"
            >Partidos</span
          >
        </div>
        <div
          class="card bg-base-100 border-base-200 rounded-xl border p-4 text-center shadow-md"
        >
          <span class="text-success text-2xl font-black">{player.wins}</span>
          <span class="text-success/70 text-[10px] font-bold uppercase"
            >Victorias ({win_pct}%)</span
          >
        </div>
        <div
          class="card bg-base-100 border-base-200 rounded-xl border p-4 text-center shadow-md"
        >
          <span class="text-warning text-2xl font-black">{player.draws}</span>
          <span class="text-warning/70 text-[10px] font-bold uppercase"
            >Empates ({draw_pct}%)</span
          >
        </div>
        <div
          class="card bg-base-100 border-base-200 rounded-xl border p-4 text-center shadow-md"
        >
          <span class="text-error text-2xl font-black">{player.losses}</span>
          <span class="text-error/70 text-[10px] font-bold uppercase"
            >Derrotas ({loss_pct}%)</span
          >
        </div>
      </div>

      <div
        class="card bg-base-100 border-base-200 rounded-xl border p-5 shadow-md"
      >
        <div class="mb-2 flex items-end justify-between">
          <div>
            <SectionTitle>Efectividad</SectionTitle>
            <p class="text-primary/60 text-[10px] font-bold uppercase">
              Vs Promedio del Club
            </p>
          </div>
          <div class="text-right">
            <span class="text-2xl font-black">{win_pct}%</span>
          </div>
        </div>
        <div class="relative pt-5">
          <div
            class="absolute top-0 z-10"
            style={`left: ${clubAverageWinPct}%`}
          >
            <span
              class={`text-[9px] font-bold uppercase text-base-content/60 whitespace-nowrap ${clubAverageWinPct > 75 ? "-translate-x-full pr-1" : "pl-1"}`}
            >
              Media ({clubAverageWinPct}%)
            </span>
          </div>
          <div
            class="bg-base-200 border-base-300 relative h-4 overflow-hidden rounded-full border"
          >
            <div
              class="border-base-content/40 absolute top-0 bottom-0 z-10 h-full border-r-2 border-dashed"
              style={`left: ${clubAverageWinPct}%`}
            >
            </div>
            <div
              class={`h-full transition-all duration-1000 ${win_pct >= clubAverageWinPct ? "bg-success" : "bg-warning"}`}
              style={`width: ${win_pct}%`}
            >
            </div>
          </div>
        </div>
        <p class="text-base-content/50 mt-3 text-[10px] italic">
          La efectividad representa el porcentaje de partidos ganados sobre el
          total jugado.
        </p>
      </div>

      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div
          class="card bg-base-100 border-base-200 overflow-hidden rounded-xl border shadow-md"
        >
          <div class="bg-base-200 border-base-200 border-b p-3 text-center">
            <h3 class="text-xs font-bold uppercase">Preferencia de Camiseta</h3>
          </div>
          <div class="flex items-center justify-around p-5">
            <div class="text-center">
              <span
                class="block text-3xl font-black text-slate-700 dark:text-slate-300"
                >{light_apps}</span
              >
              <span
                class="mt-1 flex items-center justify-center gap-1.5 text-xs font-bold text-slate-500 dark:text-slate-400"
              >
                <Icon name="material-symbols:wb-sunny" size={16} /> Claro
              </span>
            </div>
            <div class="divider divider-horizontal mx-2"></div>
            <div class="text-center">
              <span
                class="block text-3xl font-black text-slate-700 dark:text-slate-300"
                >{dark_apps}</span
              >
              <span
                class="mt-1 flex items-center justify-center gap-1.5 text-xs font-bold text-slate-600 dark:text-slate-400"
              >
                <Icon name="material-symbols:dark-mode" size={16} /> Oscuro
              </span>
            </div>
          </div>
        </div>

        <div
          class="card bg-base-100 border-base-200 flex flex-row items-center justify-center gap-4 rounded-xl border p-4 shadow-md lg:gap-5 lg:p-6"
        >
          <div class="bg-primary/10 text-primary rounded-full p-3 lg:p-4">
            <Icon
              name="material-symbols:stadium-rounded"
              size={24}
              class="lg:hidden"
            />
            <Icon
              name="material-symbols:stadium-rounded"
              size={32}
              class="hidden lg:block"
            />
          </div>
          <div class="overflow-hidden">
            <h4
              class="text-base-content/60 text-[10px] font-bold tracking-wider uppercase lg:text-xs"
            >
              Cancha Favorita
            </h4>
            <p class="truncate text-sm font-black uppercase lg:text-base">
              {topField}
            </p>
          </div>
        </div>
      </div>

      <div
        class="card bg-base-100 border-base-200 mt-6 overflow-hidden rounded-xl border shadow-md"
      >
        <div
          class="bg-base-200/50 border-base-200 flex items-center justify-between border-b p-4"
        >
          <SectionTitle>Rendimiento Anual</SectionTitle>
          <div
            class="text-base-content/60 flex items-center gap-2 text-[10px] font-bold uppercase"
          >
            <Icon name="material-symbols:table-chart" size={16} />
            Historial
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="table-zebra table-sm table w-full text-center">
            <thead>
              <tr
                class="bg-base-200 text-base-content text-xs font-bold uppercase"
              >
                <th class="pl-6 text-left">Año</th>
                <th class="bg-primary/10 text-primary font-black">PTS</th>
                <th>PJ</th>
                <th class="text-success">G</th>
                <th class="text-warning">E</th>
                <th class="text-error">P</th>
                <th>Efec.</th>
              </tr>
            </thead>
            <tbody>
              {
                yearlyStats?.map((s) => (
                  <tr class="hover text-sm">
                    <td class="pl-6 text-left font-bold">{s.year}</td>
                    <td class="bg-primary/5 text-primary text-base font-black">
                      {s.points}
                    </td>
                    <td class="font-semibold">{s.matches_played}</td>
                    <td class="font-medium">{s.wins}</td>
                    <td class="text-base-content/70 font-medium">{s.draws}</td>
                    <td class="text-base-content/70 font-medium">{s.losses}</td>
                    <td class="font-semibold">{Math.round(s.win_pct)}%</td>
                  </tr>
                ))
              }

              {
                (!yearlyStats || yearlyStats.length === 0) && (
                  <tr>
                    <td
                      colspan="7"
                      class="text-base-content/50 py-8 text-center text-sm italic"
                    >
                      No hay registros históricos disponibles.
                    </td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <div
        class="card bg-base-100 border-base-200 overflow-hidden rounded-xl border shadow-md"
      >
        <div class="bg-base-200/50 border-base-200 border-b p-4">
          <SectionTitle>Forma Reciente</SectionTitle>
        </div>
        <div class="divide-base-200 divide-y">
          {
            recentMatches?.map((match) => {
              const config = getOutcomeConfig(match.outcome);
              return (
                <div class="hover:bg-base-100 flex items-center gap-3 p-3 transition-colors">
                  <div
                    class={`flex h-10 w-10 items-center justify-center rounded-full ${config.bg} ${config.color} shrink-0`}
                  >
                    <Icon name={config.icon} size={20} />
                  </div>
                  <div class="flex min-w-0 flex-1 flex-col justify-center">
                    <span class="text-xs font-bold opacity-80">
                      {formatDate(match.date, "medium")}
                    </span>
                    <span class="text-base-content/60 truncate text-[10px] font-bold uppercase">
                      {match.fieldName}
                    </span>
                  </div>
                  <div
                    class={`badge ${config.bg} ${config.color} border-none text-[10px] font-black uppercase`}
                  >
                    {config.label}
                  </div>
                </div>
              );
            })
          }

          {
            (!recentMatches || recentMatches.length === 0) && (
              <div class="text-base-content/60 p-4 text-center text-xs">
                Sin partidos recientes
              </div>
            )
          }
        </div>
      </div>
    </div>
  </div>
</Main>
