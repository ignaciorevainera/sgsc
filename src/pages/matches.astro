---
Astro.response.headers.set("Cache-Control", "public, max-age=60, s-maxage=300");

import { supabase } from "@lib/supabase";
import Alert from "@/components/shared/Alert.astro";
import Main from "@/layouts/Main.astro";
import MatchCard from "@components/MatchCard.astro";
import Title from "@/components/shared/Title.astro";

// 1. Traemos TODOS los partidos ordenados por fecha (más reciente primero)
const { data: matches, error } = await supabase
  .from("matches")
  .select(
    `
    *,
    fields (name),
    match_players (
      team,
      players (nickname)
    )
  `
  )
  .order("date", { ascending: false });

const hasError = !!error;
const hasMatches = !hasError && matches && matches.length > 0;

// 2. Lógica para agrupar por AÑO (Temporadas)
// Transformamos la lista plana en un objeto: { "2025": [...], "2024": [...] }
const matchesByYear = (matches || []).reduce((acc, match) => {
  const year = new Date(match.date).getFullYear(); // Extraer año '2025-01-03' -> 2025
  if (!acc[year]) acc[year] = [];
  acc[year].push(match);
  return acc;
}, {});

// Obtenemos los años ordenados descendentemente (2025, 2024, 2023...)
const years = Object.keys(matchesByYear).sort((a, b) => Number(b) - Number(a));
---

<Main title="Historial | SGSC">
  <Title
    title="Historial de Partidos"
    subtitle="Revisa todos los partidos jugados en la historia del club, organizados por temporada."
  />

  {/* Error de conexión/consulta */}
  {
    hasError && (
      <Alert
        type="error"
        message="No se pudo cargar el historial de partidos. Por favor, intenta más tarde."
      />
    )
  }

  {/* Sin datos (pero sin error) */}
  {
    !hasError && !hasMatches && (
      <Alert type="info" message="No se encontraron partidos registrados." />
    )
  }

  {/* Renderizamos por AÑO */}
  {
    years.map((year) => (
      <section class="mb-10 last:mb-0">
        {/* Separador de Año */}
        <div class="mb-8 flex items-center gap-4">
          <div class="bg-base-300 h-px flex-1" />
          <div class="bg-primary flex items-center gap-3 rounded-full px-5 py-2 shadow-lg">
            <span class="text-primary-content text-2xl font-black tracking-wider">
              {year}
            </span>
            <div class="bg-primary-content/20 h-6 w-px" />
            <span class="text-primary-content/90 text-sm font-medium">
              {matchesByYear[year].length}{" "}
              {matchesByYear[year].length === 1 ? "Partido" : "Partidos"}
            </span>
          </div>
          <div class="bg-base-300 h-px flex-1" />
        </div>

        {/* Grilla de Partidos del Año */}
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          {matchesByYear[year].map((match: any) => (
            <MatchCard match={match} />
          ))}
        </div>
      </section>
    ))
  }
</Main>
