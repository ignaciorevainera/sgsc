---
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";

const supabase = createAstroSupabase(Astro);
const { id } = Astro.params;

// 1. Obtener datos para llenar el formulario
// A. El partido actual
const { data: match, error } = await supabase
  .from("matches")
  .select(`*, match_players(player_id, team)`)
  .eq("id", id)
  .single();

// Si no existe el partido, volvemos a la lista (o da error si no manejas el 404 manual)
if (!match) return Astro.redirect("/admin/matches");

// B. Listas para los selectores (Canchas y Jugadores)
const { data: fields } = await supabase
  .from("fields")
  .select("*")
  .order("name");
const { data: players } = await supabase
  .from("players")
  .select("*")
  .eq("is_active", true) // <--- Agrega esto
  .order("is_guest", { ascending: true })
  .order("nickname", { ascending: true });

// C. Calcular quién jugaba dónde para marcar los checkboxes
const lightIds = match.match_players
  .filter((mp: any) => mp.team === "light")
  .map((mp: any) => mp.player_id);
const darkIds = match.match_players
  .filter((mp: any) => mp.team === "dark")
  .map((mp: any) => mp.player_id);

// --- LÓGICA DE GUARDADO (POST) ---
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();

  // 1. Datos básicos
  const date = formData.get("date");
  const field_id = formData.get("field_id");
  const result = formData.get("result"); // 'light', 'dark', 'draw'
  const video_url = formData.get("video_url");

  // 2. Actualizar tabla MATCHES
  await supabase
    .from("matches")
    .update({
      date,
      field_id,
      result,
      video_url: video_url || null,
    })
    .eq("id", id);

  // 3. Actualizar EQUIPOS (Recolectar de radio buttons)
  const newLightIds: string[] = [];
  const newDarkIds: string[] = [];

  // Recorrer todos los jugadores y ver su selección
  players?.forEach((p) => {
    const selection = formData.get(`player_${p.id}`);
    if (selection === "light") newLightIds.push(p.id);
    if (selection === "dark") newDarkIds.push(p.id);
  });

  // Borramos los viejos
  await supabase.from("match_players").delete().eq("match_id", id);

  // Preparamos los nuevos registros
  const newPlayers = [
    ...newLightIds.map((pid) => ({
      match_id: id,
      player_id: pid,
      team: "light",
    })),
    ...newDarkIds.map((pid) => ({
      match_id: id,
      player_id: pid,
      team: "dark",
    })),
  ];

  // Insertamos los nuevos
  if (newPlayers.length > 0) {
    await supabase.from("match_players").insert(newPlayers);
  }

  return Astro.redirect(`/admin/matches/edit/${id}?success=true`);
}
---

<Main title="Editar Partido | SGSC">
  <Title title="Editar Partido" subtitle="Panel de Administración" />

  {/* Alerta de éxito */}
  {
    Astro.url.searchParams.get("success") && (
      <div role="alert" class="alert alert-success mb-6 rounded-xl shadow-md">
        <Icon name="material-symbols:check-circle" size={22} />
        <span class="flex-1 text-sm sm:text-base">
          ¡Partido actualizado correctamente!
        </span>
        <a href="/matches" class="btn btn-sm btn-ghost rounded-xl">
          <Icon name="material-symbols:arrow-back" size={18} />
          <span class="hidden sm:inline">Volver al historial</span>
        </a>
      </div>
    )
  }

  <form method="POST" class="space-y-6">
    {/* Sección: Información General */}
    <div
      class="bg-base-100 border-base-200 space-y-6 rounded-xl border p-4 shadow-md sm:p-6"
    >
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:gap-6">
        {/* Fecha */}
        <div class="form-control">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Fecha del Partido</legend>
            <input
              type="date"
              name="date"
              class="input input-bordered w-full rounded-xl"
              required
              value={match.date}
            />
          </fieldset>
        </div>

        {/* Sede */}
        <div class="form-control">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Sede</legend>
            <select
              name="field_id"
              class="select select-bordered w-full rounded-xl"
            >
              {
                fields?.map((f) => (
                  <option value={f.id} selected={f.id === match.field_id}>
                    {f.name}
                  </option>
                ))
              }
            </select>
          </fieldset>
        </div>

        {/* Resultado */}
        <div class="form-control">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Resultado Final </legend>
            <select
              name="result"
              class="select select-bordered w-full rounded-xl font-bold"
            >
              <option value="light" selected={match.result === "light"}>
                Claro
              </option>
              <option value="dark" selected={match.result === "dark"}>
                Oscuro
              </option>
              <option value="draw" selected={match.result === "draw"}>
                Empate
              </option>
            </select>
          </fieldset>
        </div>

        {/* Video URL */}
        <div class="form-control">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Enlace de Video</legend>
            <input
              type="url"
              name="video_url"
              class="input input-bordered w-full rounded-xl"
              placeholder="https://..."
              value={match.video_url}
            />
          </fieldset>
        </div>
      </div>
    </div>

    {/* Divider */}
    <div
      class="divider text-base-content/60 text-xs font-bold tracking-wider uppercase"
    >
      Convocatoria
    </div>

    {/* Sección: Equipos */}
    <div
      class="bg-base-100 border-base-200 max-h-96 overflow-auto rounded-xl border shadow-md"
    >
      {/* Header */}
      <div
        class="bg-base-200 sticky top-0 z-10 grid grid-cols-[1fr_2.5rem_2.5rem_2.5rem] items-center gap-1 px-3 py-2 sm:grid-cols-[1fr_3rem_3rem_3rem] sm:gap-2"
      >
        <span class="text-xs font-bold sm:text-sm">Jugador</span>
        <span class="text-base-content/60 text-center text-xs">—</span>
        <span class="flex justify-center">
          <Icon
            name="material-symbols:wb-sunny"
            class="text-base text-slate-500 sm:text-xl dark:text-slate-300"
          />
        </span>
        <span class="flex justify-center">
          <Icon
            name="material-symbols:dark-mode"
            class="text-base text-slate-500 sm:text-xl dark:text-slate-300"
          />
        </span>
      </div>

      {/* Filas de jugadores */}
      <div class="divide-base-200 divide-y">
        {
          players?.map((p) => {
            const isLight = lightIds.includes(p.id);
            const isDark = darkIds.includes(p.id);
            const isNone = !isLight && !isDark;

            return (
              <div class="hover:bg-base-200/50 grid grid-cols-[1fr_2.5rem_2.5rem_2.5rem] items-center gap-1 px-3 py-2 transition-colors sm:grid-cols-[1fr_3rem_3rem_3rem] sm:gap-2">
                {/* Nombre */}
                <div class="flex min-w-0 items-center gap-1">
                  <span
                    class="tooltip tooltip-right truncate text-xs font-bold sm:text-sm"
                    data-tip={p.nickname}
                  >
                    {p.nickname}
                  </span>
                  {p.is_guest && (
                    <span class="badge badge-ghost badge-xs border-base-300 shrink-0 opacity-60">
                      INV
                    </span>
                  )}
                </div>

                {/* No juega */}
                <div class="flex justify-center">
                  <input
                    type="radio"
                    name={`player_${p.id}`}
                    value="none"
                    class="radio radio-xs sm:radio-sm radio-error"
                    checked={isNone}
                  />
                </div>

                {/* Claro */}
                <div class="flex justify-center rounded">
                  <input
                    type="radio"
                    name={`player_${p.id}`}
                    value="light"
                    class="radio radio-xs sm:radio-sm radio-warning"
                    checked={isLight}
                  />
                </div>

                {/* Oscuro */}
                <div class="flex justify-center rounded">
                  <input
                    type="radio"
                    name={`player_${p.id}`}
                    value="dark"
                    class="player-selector radio radio-xs sm:radio-sm radio-neutral dark:radio-primary"
                    checked={isDark}
                  />
                </div>
              </div>
            );
          })
        }
      </div>
    </div>

    {/* Botones de acción */}
    <div
      class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
    >
      <a
        href="/admin/matches"
        class="btn btn-ghost order-2 w-full rounded-xl sm:order-1 sm:w-auto"
      >
        <Icon name="material-symbols:arrow-back" size={18} />
        Cancelar
      </a>
      <button
        type="submit"
        class="btn btn-primary order-1 w-full gap-2 rounded-xl shadow-md transition-all hover:scale-[1.02] hover:shadow-lg active:scale-[0.98] sm:order-2 sm:w-auto sm:px-8"
      >
        <Icon name="material-symbols:save" size={20} />
        Guardar Cambios
      </button>
    </div>
  </form>
</Main>
