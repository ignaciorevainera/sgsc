---
import Main from "@/layouts/Main.astro";
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import TableWrapper from "@/components/shared/TableWrapper.astro";

const supabase = createAstroSupabase(Astro);

// 1. Verificar sesión (Seguridad extra)
const {
  data: { session },
} = await supabase.auth.getSession();
if (!session) return Astro.redirect("/signin");

// 2. Obtener partidos (Compacto: solo lo necesario para identificar el partido)
const { data: matches } = await supabase
  .from("matches")
  .select(
    `
    id,
    date,
    result,
    video_url,
    fields (name)
  `
  )
  .order("date", { ascending: false });

// Helper para formato de fecha corto
const formatDate = (dateString: string) => {
  return new Date(dateString + "T00:00:00").toLocaleDateString("es-AR", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
  });
};
---

<Main title="Administrar Partidos">
  <div class="mx-auto max-w-4xl px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1
          class="flex items-center gap-2 text-2xl font-black uppercase italic"
        >
          <Icon
            name="material-symbols:edit-document-rounded"
            class="text-secondary"
          />
          Historial de Partidos
        </h1>
        <p class="text-base-content/60 mt-1 text-xs font-bold uppercase">
          {matches?.length || 0} partidos registrados
        </p>
      </div>

      <a
        href="/admin/matches/create"
        class="btn btn-primary btn-sm gap-2 rounded-xl shadow-md"
      >
        <Icon name="material-symbols:add" size={18} />
        Nuevo
      </a>
    </div>

    <TableWrapper>
      <table class="table-sm table w-full">
        <thead>
          <tr
            class="bg-base-200/50 text-base-content/60 text-xs font-bold uppercase"
          >
            <th class="w-24">Fecha</th>
            <th>Sede</th>
            <th class="text-center">Resultado</th>
            <th class="text-center">Media</th>
            <th class="pr-4 text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {
            matches?.map((match) => (
              <tr class="hover group transition-colors">
                <td class="font-mono text-xs font-bold opacity-70">
                  {formatDate(match.date)}
                </td>

                <td class="max-w-37.5 truncate text-sm font-bold">
                  {match.fields?.[0]?.name || "Sin cancha"}
                </td>

                <td class="text-center">
                  {match.result === "draw" && (
                    <span class="badge badge-warning badge-xs font-bold">
                      Empate
                    </span>
                  )}
                  {match.result === "light" && (
                    <span class="badge badge-outline badge-xs bg-white font-bold text-black">
                      Claro
                    </span>
                  )}
                  {match.result === "dark" && (
                    <span class="badge badge-neutral badge-xs font-bold">
                      Oscuro
                    </span>
                  )}
                </td>

                <td class="text-center">
                  {match.video_url ? (
                    <a
                      href={match.video_url}
                      target="_blank"
                      class="text-primary inline-block transition-transform hover:scale-125"
                    >
                      <Icon name="material-symbols:play-circle" size={18} />
                    </a>
                  ) : (
                    <span class="opacity-10">-</span>
                  )}
                </td>

                <td class="text-right">
                  <a
                    href={`/admin/matches/edit/${match.id}`}
                    class="btn btn-square btn-ghost btn-xs text-info hover:bg-info/10"
                    title="Editar detalles"
                  >
                    <Icon
                      name="material-symbols:edit-square-outline"
                      size={16}
                    />
                  </a>
                </td>
              </tr>
            ))
          }

          {
            (!matches || matches.length === 0) && (
              <tr>
                <td
                  colspan="5"
                  class="text-base-content/60 py-8 text-center text-sm italic"
                >
                  No hay partidos cargados todavía.
                </td>
              </tr>
            )
          }
        </tbody>
      </table>
    </TableWrapper>
  </div>
</Main>
