---
import Main from "@/layouts/Main.astro";
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import TableWrapper from "@/components/shared/TableWrapper.astro";
import PageHeader from "@/components/shared/PageHeader.astro";

const supabase = createAstroSupabase(Astro);

const {
  data: { session },
} = await supabase.auth.getSession();
if (!session) return Astro.redirect("/signin");

const { data: matches } = await supabase
  .from("matches")
  .select(
    `
    id,
    date,
    result,
    video_url,
    fields (name)
  `
  )
  .order("date", { ascending: false });

const formatDate = (dateString: string) => {
  return new Date(dateString + "T00:00:00").toLocaleDateString("es-AR", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
  });
};
---

<Main title="Administrar Partidos">
  <div class="mx-auto max-w-7xl px-4 py-6 lg:py-8">
    <div
      class="mb-6 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center lg:mb-8"
    >
      <div>
        <PageHeader title="Historial de Partidos" backHref="/admin" />
        <p
          class="text-base-content/60 mt-2 text-xs font-bold uppercase lg:text-sm"
        >
          {matches?.length || 0} partidos registrados
        </p>
      </div>

      <a
        href="/admin/matches/create"
        class="btn btn-primary btn-sm lg:btn-md gap-2 rounded-xl shadow-md"
      >
        <Icon name="material-symbols:add" size={18} />
        Nuevo Partido
      </a>
    </div>

    <TableWrapper>
      <table class="table-xs sm:table-sm lg:table-md table w-full">
        <thead>
          <tr
            class="bg-base-200/50 text-base-content/60 text-xs font-bold uppercase lg:text-sm"
          >
            <th class="w-20 lg:w-28">Fecha</th>
            <th>Sede</th>
            <th class="text-center">Resultado</th>
            <th class="hidden text-center sm:table-cell">Media</th>
            <th class="pr-4 text-right lg:pr-6">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {
            matches?.map((match) => (
              <tr class="hover group transition-colors">
                <td class="font-mono text-xs font-bold opacity-70 lg:text-sm">
                  {formatDate(match.date)}
                </td>

                <td class="max-w-[150px] truncate text-sm font-bold lg:max-w-none lg:text-base">
                  {(match.fields as any)?.name || "Sin cancha"}
                </td>

                <td class="text-center">
                  {match.result === "draw" && (
                    <span class="badge badge-warning badge-xs lg:badge-sm font-bold">
                      Empate
                    </span>
                  )}
                  {match.result === "light" && (
                    <span class="badge badge-outline badge-xs lg:badge-sm bg-white font-bold text-black">
                      Claro
                    </span>
                  )}
                  {match.result === "dark" && (
                    <span class="badge badge-outline badge-xs lg:badge-sm font-bold">
                      Oscuro
                    </span>
                  )}
                </td>

                <td class="hidden text-center sm:table-cell">
                  {match.video_url ? (
                    <Icon
                      name="material-symbols:videocam"
                      class="text-success inline"
                      size={18}
                    />
                  ) : (
                    <Icon
                      name="material-symbols:videocam-off"
                      class="text-base-content/30 inline"
                      size={18}
                    />
                  )}
                </td>

                <td class="pr-4 text-right lg:pr-6">
                  <a
                    href={`/admin/matches/edit/${match.id}`}
                    class="btn btn-square btn-ghost btn-xs text-info lg:btn-sm"
                    title="Editar partido"
                  >
                    <Icon
                      name="material-symbols:edit"
                      size={16}
                      class="lg:hidden"
                    />
                    <Icon
                      name="material-symbols:edit"
                      size={18}
                      class="hidden lg:block"
                    />
                  </a>
                </td>
              </tr>
            ))
          }

          {
            (!matches || matches.length === 0) && (
              <tr>
                <td
                  colspan="5"
                  class="text-base-content/60 py-12 text-center text-sm lg:text-base"
                >
                  No hay partidos registrados a√∫n.
                </td>
              </tr>
            )
          }
        </tbody>
      </table>
    </TableWrapper>
  </div>
</Main>
