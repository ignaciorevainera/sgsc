---
import { createAstroSupabase } from "@/lib/supabase";
import { formatDate } from "@/lib/utils/dateUtils";
import { Icon } from "astro-icon/components";
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";

const supabase = createAstroSupabase(Astro);

const {
  data: { session },
} = await supabase.auth.getSession();
if (!session) return Astro.redirect("/signin");

const { data: matches } = await supabase
  .from("matches")
  .select(
    `
    id,
    date,
    result,
    video_url,
    fields (name)
  `
  )
  .order("date", { ascending: false });
---

<Main title="Administrar Partidos">
  <Title title="Historial de Partidos" subtitle="Panel de Administración" />

  {/* Header con contador y botón */}
  <div
    class="mb-4 flex flex-col gap-3 sm:mb-6 sm:flex-row sm:items-center sm:justify-between"
  >
    <span class="text-base-content/60 text-sm font-bold uppercase">
      {matches?.length || 0} partidos registrados
    </span>
    <a
      href="/admin/matches/create"
      class="btn btn-primary btn-sm sm:btn-md gap-2 rounded-xl shadow-md"
    >
      <Icon name="material-symbols:add" size={18} />
      <span class="sm:inline">Nuevo Partido</span>
    </a>
  </div>

  {/* Lista de partidos */}
  <div
    class="bg-base-100 border-base-200 overflow-hidden rounded-xl border shadow-md"
  >
    {/* Header */}
    <div
      class="bg-base-200/50 text-base-content/60 grid grid-cols-[4.5rem_1fr_2.5rem_2.5rem_2.5rem] items-center gap-1 px-2 py-2 text-xs font-bold uppercase sm:grid-cols-[6rem_1fr_3rem_3rem_3rem] sm:gap-2 sm:px-3"
    >
      <span>Fecha</span>
      <span>Sede</span>
      <span class="flex justify-center text-center">
        <Icon
          name="material-symbols:emoji-events"
          size={14}
          class="sm:hidden"
        />
        <span class="hidden sm:inline">Res.</span>
      </span>
      <span class="flex justify-center text-center">
        <Icon name="material-symbols:videocam" size={14} class="sm:hidden" />
        <span class="hidden sm:inline">Video</span>
      </span>
      <span class="sr-only">Acciones</span>
    </div>

    {/* Filas de partidos */}
    <div class="divide-base-200 divide-y">
      {
        matches?.map((match) => (
          <div class="hover:bg-base-200/50 grid grid-cols-[4.5rem_1fr_2.5rem_2.5rem_2.5rem] items-center gap-1 px-2 py-2 transition-colors sm:grid-cols-[6rem_1fr_3rem_3rem_3rem] sm:gap-2 sm:px-3">
            {/* Fecha */}
            <span class="font-mono text-xs font-semibold opacity-70">
              {formatDate(match.date, "short")}
            </span>

            {/* Sede */}
            <div class="flex min-w-0 items-center gap-1.5">
              <Icon
                name="material-symbols:location-on"
                size={14}
                class="text-secondary hidden shrink-0 sm:inline"
              />
              <span class="truncate text-xs font-medium sm:text-sm">
                {(match.fields as any)?.name || "Sin sede"}
              </span>
            </div>

            {/* Resultado */}
            <div class="flex justify-center">
              {match.result === "draw" && (
                <span class="tooltip tooltip-left" data-tip="Empate">
                  <Icon
                    name="material-symbols:balance"
                    size={20}
                    class="text-yellow-500"
                  />
                </span>
              )}
              {match.result === "light" && (
                <span class="tooltip tooltip-left" data-tip="Ganó Claro">
                  <Icon
                    name="material-symbols:wb-sunny"
                    size={20}
                    class="text-slate-500"
                  />
                </span>
              )}
              {match.result === "dark" && (
                <span class="tooltip tooltip-left" data-tip="Ganó Oscuro">
                  <Icon
                    name="material-symbols:dark-mode"
                    size={20}
                    class="text-slate-700"
                  />
                </span>
              )}
            </div>

            {/* Video */}
            <div class="flex justify-center">
              {match.video_url ? (
                <a
                  href={match.video_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-success hover:text-success-content transition-colors"
                  title="Ver video del partido"
                >
                  <Icon name="material-symbols:play-circle" size={20} />
                </a>
              ) : (
                <span class="text-base-content/20" title="Sin video">
                  <Icon name="material-symbols:videocam-off" size={18} />
                </span>
              )}
            </div>

            {/* Acciones */}
            <div class="flex justify-center">
              <a
                href={`/admin/matches/edit/${match.id}`}
                class="text-info hover:text-info-content transition-colors"
                title="Editar partido"
              >
                <Icon name="material-symbols:edit" size={20} />
              </a>
            </div>
          </div>
        ))
      }

      {/* Empty state */}
      {
        (!matches || matches.length === 0) && (
          <div class="text-base-content/60 flex flex-col items-center gap-2 py-12 text-center text-sm">
            <Icon
              name="material-symbols:sports-soccer"
              size={48}
              class="text-base-content/20"
            />
            <span>No hay partidos registrados aún.</span>
          </div>
        )
      }
    </div>
  </div>
</Main>
