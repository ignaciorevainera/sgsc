---
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import Alert from "@/components/shared/Alert.astro";
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";

const supabase = createAstroSupabase(Astro);
const { id } = Astro.params;

// Obtener datos actuales
const { data: player } = await supabase
  .from("players")
  .select("*")
  .eq("id", id)
  .single();
if (!player) return Astro.redirect("/admin/players");

// --- UPDATE ---
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");

  let error = null;

  if (action === "toggle_status") {
    // Borrado Lógico
    const newStatus = !player.is_active;
    const { error: updateError } = await supabase
      .from("players")
      .update({ is_active: newStatus })
      .eq("id", id);
    error = updateError;
  } else {
    // Edición normal
    const nickname = formData.get("nickname");
    // CAMBIO: first_name y last_name
    const first_name = formData.get("first_name");
    const last_name = formData.get("last_name");
    const birth_date = formData.get("birth_date");
    const rawFoot = formData.get("preferred_foot");
    const preferred_foot = rawFoot === "" ? null : rawFoot;
    const is_guest = formData.has("is_guest");

    const { error: updateError } = await supabase
      .from("players")
      .update({
        nickname,
        first_name: first_name || null, // CAMBIO
        last_name: last_name || null, // CAMBIO
        birth_date: birth_date || null,
        preferred_foot: preferred_foot || null,
        is_guest,
      })
      .eq("id", id);
    error = updateError;
  }

  if (error) {
    console.error("Error al actualizar jugador:", error);
    return new Response(JSON.stringify(error), { status: 500 });
  }

  return Astro.redirect(`/admin/players/edit/${id}?success=true`);
}
---

<Main title="Editar Jugador">
  <Title title="Editar Jugador" subtitle="Panel de Administración" />
  {
    Astro.url.searchParams.get("success") && (
      <Alert
        type="success"
        message="Cambios guardados correctamente."
        class="mb-4"
      />
    )
  }

  <div class="flex flex-col gap-6">
    <form
      method="POST"
      class="card bg-base-100 border-base-200 space-y-6 rounded-xl border p-4 shadow-md sm:p-6"
    >
      <input type="hidden" name="action" value="update" />

      <div class="grid grid-cols-4 gap-2">
        <div class="form-control col-span-4">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Apodo</legend>
            <input
              type="text"
              name="nickname"
              value={player.nickname}
              required
              class="input input-bordered w-full rounded-xl"
            />
          </fieldset>
        </div>

        <div class="form-control col-span-2">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Nombre</legend>
            <input
              type="text"
              name="first_name"
              value={player.first_name || ""}
              class="input input-bordered w-full rounded-xl"
            />
          </fieldset>
        </div>

        <div class="form-control col-span-2">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Apellido</legend>
            <input
              type="text"
              name="last_name"
              value={player.last_name || ""}
              class="input input-bordered w-full rounded-xl"
            />
          </fieldset>
        </div>

        <div class="form-control col-span-4 sm:col-span-2">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Fecha Nacimiento</legend>
            <input
              type="date"
              name="birth_date"
              value={player.birth_date}
              class="input input-bordered w-full rounded-xl"
            />
          </fieldset>
        </div>

        <div class="form-control col-span-4 sm:col-span-2">
          <fieldset class="fieldset">
            <legend class="fieldset-legend">Pie Hábil</legend>
            <select
              name="preferred_foot"
              class="select select-bordered w-full rounded-xl"
            >
              <option value="" selected={player.preferred_foot === null}
                >No especificado</option
              >
              <option value="right" selected={player.preferred_foot === "right"}
                >Diestro</option
              >
              <option value="left" selected={player.preferred_foot === "left"}
                >Zurdo</option
              >
              <option value="both" selected={player.preferred_foot === "both"}
                >Ambidiestro
              </option>
            </select>
          </fieldset>
        </div>
        
        <div class="form-control col-span-4">
          <label
            for="is_guest"
            class="mt-2 flex cursor-pointer flex-row items-center justify-start gap-3"
          >
            <input
              type="checkbox"
              name="is_guest"
              id="is_guest"
              class="checkbox checkbox-sm"
              checked={player.is_guest}
            />
            <div class="flex flex-col items-start">
              <span class="font-bold">Marcar como Invitado</span>
              <span class="text-base-content/60 text-xs">
                Los invitados aparecen al final de las listas de convocatoria.
              </span>
            </div>
          </label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary rounded-xl shadow-md"
        >Actualizar Datos</button
      >
    </form>

    <div class="card bg-base-200 border-base-200 rounded-xl border p-4 sm:p-6">
      <h3 class="text-base-content/60 mb-2 text-xs font-bold uppercase">
        Zona de Estado
      </h3>
      <div class="flex items-center justify-between gap-2">
        <div>
          <span class="block font-bold">Estado Actual</span>
          <span class="text-xs opacity-70">
            {
              player.is_active
                ? "El jugador aparece en las listas."
                : "El jugador está archivado."
            }
          </span>
        </div>

        <form method="POST">
          <input type="hidden" name="action" value="toggle_status" />
          {
            player.is_active ? (
              <button class="btn btn-error btn-sm sm:btn-md rounded-xl text-white">
                <Icon name="material-symbols:archive" /> Desactivar
              </button>
            ) : (
              <button class="btn btn-success btn-sm sm:btn-md rounded-xl text-white">
                <Icon name="material-symbols:unarchive" /> Reactivar
              </button>
            )
          }
        </form>
      </div>
    </div>
  </div>
</Main>
