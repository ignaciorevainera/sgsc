---
import Main from "@/layouts/Main.astro";
import Title from "@/components/shared/Title.astro";
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import PageHeader from "@/components/shared/PageHeader.astro";
import Alert from "@/components/shared/Alert.astro";

const supabase = createAstroSupabase(Astro);
const { id } = Astro.params;

// Obtener datos actuales
const { data: player } = await supabase
  .from("players")
  .select("*")
  .eq("id", id)
  .single();
if (!player) return Astro.redirect("/admin/players");

// --- UPDATE ---
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");

  let error = null;

  if (action === "toggle_status") {
    // Borrado Lógico
    const newStatus = !player.is_active;
    const { error: updateError } = await supabase
      .from("players")
      .update({ is_active: newStatus })
      .eq("id", id);
    error = updateError;
  } else {
    // Edición normal
    const nickname = formData.get("nickname");
    // CAMBIO: first_name y last_name
    const first_name = formData.get("first_name");
    const last_name = formData.get("last_name");
    const birth_date = formData.get("birth_date");
    const preferred_foot = formData.get("preferred_foot");

    const { error: updateError } = await supabase
      .from("players")
      .update({
        nickname,
        first_name: first_name || null, // CAMBIO
        last_name: last_name || null, // CAMBIO
        birth_date: birth_date || null,
        preferred_foot: preferred_foot || null,
      })
      .eq("id", id);
    error = updateError;
  }

  if (error) {
    console.error("Error al actualizar jugador:", error);
    return new Response(JSON.stringify(error), { status: 500 });
  }

  return Astro.redirect(`/admin/players/edit/${id}?success=true`);
}
---

<Main title="Editar Jugador">
  <Title title="Editar Jugador" subtitle="Panel de Administración" />
  <div class="mx-auto max-w-lg px-4 py-8">
    {
      Astro.url.searchParams.get("success") && (
        <Alert
          type="success"
          message="Cambios guardados correctamente."
          class="mb-4"
        />
      )
    }

    <form
      method="POST"
      class="card bg-base-100 border-base-200 mb-8 space-y-6 rounded-xl border p-4 shadow-md sm:p-6"
    >
      <input type="hidden" name="action" value="update" />

      <div class="form-control">
        <label class="label">
          <span
            class="label-text text-base-content/60 text-xs font-bold uppercase"
            >Apodo</span
          >
        </label>
        <input
          type="text"
          name="nickname"
          value={player.nickname}
          required
          class="input input-bordered w-full rounded-xl"
        />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label">
            <span
              class="label-text text-base-content/60 text-xs font-bold uppercase"
              >Nombre</span
            >
          </label>
          <input
            type="text"
            name="first_name"
            value={player.first_name || ""}
            class="input input-bordered w-full rounded-xl"
          />
        </div>
        <div class="form-control">
          <label class="label">
            <span
              class="label-text text-base-content/60 text-xs font-bold uppercase"
              >Apellido</span
            >
          </label>
          <input
            type="text"
            name="last_name"
            value={player.last_name || ""}
            class="input input-bordered w-full rounded-xl"
          />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label">
            <span
              class="label-text text-base-content/60 text-xs font-bold uppercase"
              >Fecha Nacimiento</span
            >
          </label>
          <input
            type="date"
            name="birth_date"
            value={player.birth_date}
            class="input input-bordered w-full rounded-xl"
          />
        </div>
        <div class="form-control">
          <label class="label">
            <span
              class="label-text text-base-content/60 text-xs font-bold uppercase"
              >Pie Hábil</span
            >
          </label>
          <select
            name="preferred_foot"
            class="select select-bordered w-full rounded-xl"
          >
            <option value="right" selected={player.preferred_foot === "right"}
              >Diestro</option
            >
            <option value="left" selected={player.preferred_foot === "left"}
              >Zurdo</option
            >
            <option value="both" selected={player.preferred_foot === "both"}
              >Ambidiestro</option
            >
          </select>
        </div>
      </div>

      <button
        type="submit"
        class="btn btn-primary btn-block mt-6 rounded-xl shadow-md transition-all hover:scale-[1.02] hover:shadow-lg active:scale-[0.98]"
        >Actualizar Datos</button
      >
    </form>

    <div class="card bg-base-200 border-base-200 rounded-xl border p-4 sm:p-6">
      <h3 class="text-base-content/60 mb-2 text-xs font-bold uppercase">
        Zona de Estado
      </h3>
      <div class="flex items-center justify-between">
        <div>
          <span class="block font-bold">Estado Actual</span>
          <span class="text-xs opacity-70">
            {
              player.is_active
                ? "El jugador aparece en las listas."
                : "El jugador está archivado."
            }
          </span>
        </div>

        <form method="POST">
          <input type="hidden" name="action" value="toggle_status" />
          {
            player.is_active ? (
              <button class="btn btn-error btn-sm rounded-xl text-white">
                <Icon name="material-symbols:archive" /> Desactivar
              </button>
            ) : (
              <button class="btn btn-success btn-sm rounded-xl text-white">
                <Icon name="material-symbols:unarchive" /> Reactivar
              </button>
            )
          }
        </form>
      </div>
    </div>
  </div>
</Main>
