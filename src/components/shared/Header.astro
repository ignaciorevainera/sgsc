---
import { createAstroSupabase } from "@/lib/supabase";
import { Icon } from "astro-icon/components";
import Avatar from "@/components/Avatar.astro";

// 2. Lógica de sesión en el servidor
const supabase = createAstroSupabase(Astro);
const {
  data: { session },
} = await supabase.auth.getSession();
const isLoggedIn = !!session;

const links = [
  { href: "/ranking", label: "Clasificación" },
  { href: "/matches", label: "Partidos" },
  { href: "/players", label: "Jugadores" },
  { href: "/teams", label: "Equipos" },
  { href: "/fields", label: "Canchas" },
  { href: "/hall-of-fame", label: "Salón de la Fama" },
];
const currentPath = Astro.url.pathname;
---

<header
  id="site-header"
  class="navbar bg-base-100/90 sticky top-0 z-50 rounded-b-xl shadow-none backdrop-blur transition-shadow"
  role="banner"
>
  <div class="navbar-start">
    <div class="dropdown">
      <button
        tabindex="0"
        type="button"
        aria-label="Abrir menú de navegación"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="btn btn-ghost lg:hidden"
        role="button"
      >
        <Icon
          name="material-symbols:menu-rounded"
          size={24}
          aria-hidden="true"
        />
      </button>
      <ul
        tabindex="-1"
        id="mobile-menu"
        class="menu dropdown-content bg-base-100 z-10 mt-4 w-52 rounded-xl p-2 shadow-md"
        role="menu"
      >
        {
          links.map((link) => (
            <li>
              <a
                href={link.href}
                class={
                  currentPath.startsWith(link.href)
                    ? "active text-primary font-bold"
                    : ""
                }
              >
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    <a href="/" class="btn btn-ghost text-xl font-bold">SGSC</a>
  </div>

  <nav class="navbar-center hidden lg:flex" aria-label="Navegación principal">
    <ul class="menu menu-horizontal px-1" role="menubar">
      {
        links.map((link) => (
          <li>
            <a
              href={link.href}
              class={
                currentPath.startsWith(link.href)
                  ? "active text-primary font-bold"
                  : ""
              }
            >
              {link.label}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>

  <div class="navbar-end gap-1">
    {/* LÓGICA CONDICIONAL: ¿Está logueado? */}
    {
      isLoggedIn ? (
        // OPCIÓN A: USUARIO LOGUEADO (Dropdown con Avatar)
        <div class="dropdown dropdown-end">
          <button
            tabindex="0"
            role="button"
            type="button"
            aria-label="Menú de usuario administrador"
            aria-expanded="false"
            aria-haspopup="true"
            class="btn btn-ghost btn-circle"
          >
            <Avatar initial="A" size="xs" ring={false} interactive={false} />
          </button>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 border-base-200 z-50 mt-4 w-56 rounded-xl border p-2 shadow-md"
            role="menu"
            aria-label="Opciones de administrador"
          >
            <li class="menu-title text-base-content/60 text-xs uppercase">
              Administrador
            </li>

            <li>
              <a href="/admin">
                <Icon
                  name="material-symbols:space-dashboard-rounded"
                  size={18}
                />
                Panel de Control
              </a>
            </li>

            <div class="divider m-0" />

            <li class="menu-title text-base-content/60 text-xs uppercase">
              Accesos Rápidos
            </li>

            <li>
              <a href="/admin/matches/create">
                <Icon
                  name="material-symbols:add-circle"
                  size={16}
                  class="text-primary"
                />
                Nuevo Partido
              </a>
            </li>
            <li>
              <a href="/admin/matches">
                <Icon
                  name="material-symbols:edit-document-rounded"
                  size={16}
                  class="text-secondary"
                />
                Historial de Partidos
              </a>
            </li>
            <li>
              <a href="/admin/players/create">
                <Icon
                  name="material-symbols:person-add"
                  size={16}
                  class="text-accent"
                />
                Nuevo Jugador
              </a>
            </li>
            <li>
              <a href="/admin/players">
                <Icon
                  name="material-symbols:list-alt"
                  size={16}
                  class="text-info"
                />
                Gestionar Plantel
              </a>
            </li>

            <div class="divider m-0" />

            <li>
              <form
                action="/api/auth/signout"
                method="POST"
                class="btn btn-ghost text-error w-full"
              >
                <button
                  type="submit"
                  class="flex w-full cursor-pointer items-center gap-2"
                >
                  <Icon name="material-symbols:logout" size={16} />
                  Cerrar Sesión
                </button>
              </form>
            </li>
          </ul>
        </div>
      ) : (
        // OPCIÓN B: NO LOGUEADO (Botón candado)
        // Nota: Asegúrate de que tu ruta sea '/signin' o '/login' según tu archivo
        <a
          href="/login"
          class="btn btn-ghost btn-circle"
          aria-label="Acceso a panel de administración"
          data-tip="Acceso Admin"
        >
          <Icon
            name="material-symbols:lock-person"
            size={24}
            aria-hidden="true"
          />
        </a>
      )
    }

    {/* Botón de Tema (Mantenemos el original) */}
    <button
      class="btn btn-ghost btn-circle"
      data-toggle-theme="light,dark"
      data-act-class="ACTIVECLASS"
      aria-label="Cambiar tema de colores"
      type="button"
    >
      <Icon name="material-symbols:contrast" size={24} aria-hidden="true" />
    </button>
  </div>
</header>

<script>
  const header = document.getElementById("site-header");
  const toggleShadow = () => {
    if (!header) return;
    const scrolled = window.scrollY > 4;
    header.classList.toggle("shadow-md", scrolled);
    header.classList.toggle("shadow-none", !scrolled);
  };

  toggleShadow();
  window.addEventListener("scroll", toggleShadow, { passive: true });
</script>
