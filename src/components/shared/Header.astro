---
import { Icon } from "astro-icon/components";
import Avatar from "@/components/Avatar.astro";
import { createAstroSupabase } from "@/lib/supabase"; // 1. Importamos cliente SSR

// 2. Lógica de sesión en el servidor
const supabase = createAstroSupabase(Astro);
const {
  data: { session },
} = await supabase.auth.getSession();
const isLoggedIn = !!session;

const links = [
  { href: "/ranking", label: "Clasificación" },
  { href: "/matches", label: "Partidos" },
  { href: "/players", label: "Jugadores" },
  { href: "/teams", label: "Equipos" },
  { href: "/fields", label: "Canchas" },
  { href: "/hall-of-fame", label: "Salón de la Fama" },
];
const currentPath = Astro.url.pathname;
---

<header
  id="site-header"
  class="navbar bg-base-100/90 sticky top-0 z-50 rounded-b-xl shadow-none backdrop-blur transition-shadow"
>
  <div class="navbar-start">
    <div class="dropdown">
      <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
        <Icon name="material-symbols:menu-rounded" size={24} />
      </div>
      <ul
        tabindex="-1"
        class="menu dropdown-content bg-base-100 z-10 mt-4 w-52 rounded-xl p-2 shadow-md"
      >
        {
          links.map((link) => (
            <li>
              <a
                href={link.href}
                class={
                  currentPath.startsWith(link.href)
                    ? "active text-primary font-bold"
                    : ""
                }
              >
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    <a href="/" class="btn btn-ghost text-xl font-bold">SGSC</a>
  </div>

  <div class="navbar-center hidden lg:flex">
    <ul class="menu menu-horizontal px-1">
      {
        links.map((link) => (
          <li>
            <a
              href={link.href}
              class={
                currentPath.startsWith(link.href)
                  ? "active text-primary font-bold"
                  : ""
              }
            >
              {link.label}
            </a>
          </li>
        ))
      }
    </ul>
  </div>

  <div class="navbar-end gap-1">
    {/* LÓGICA CONDICIONAL: ¿Está logueado? */}
    {
      isLoggedIn ? (
        // OPCIÓN A: USUARIO LOGUEADO (Dropdown con Avatar)
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
            <Avatar initial="A" size="xs" ring={false} interactive={false} />
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 border-base-200 z-50 mt-3 w-52 rounded-xl border p-2 shadow-md"
          >
            <li class="menu-title text-base-content/60 text-[10px] uppercase">
              Administrador
            </li>

            {/* --- CAMBIO PRINCIPAL: Enlace al Dashboard --- */}
            <li>
              <a href="/admin" class="flex items-center gap-2 font-semibold">
                <Icon
                  name="material-symbols:dashboard"
                  size={18}
                  class="text-primary"
                />
                Panel de Control
              </a>
            </li>
            {/* --------------------------------------------- */}

            <div class="divider my-0" />

            <li>
              <form
                action="/api/auth/signout"
                method="POST"
                class="p-0 hover:bg-transparent"
              >
                <button
                  type="submit"
                  class="text-error flex w-full items-center gap-2 px-3 py-2 text-left"
                >
                  <Icon name="material-symbols:logout" size={16} />
                  Cerrar Sesión
                </button>
              </form>
            </li>
          </ul>
        </div>
      ) : (
        // OPCIÓN B: NO LOGUEADO (Botón candado)
        // Nota: Asegúrate de que tu ruta sea '/signin' o '/login' según tu archivo
        <a
          href="/login"
          class="btn btn-ghost btn-circle tooltip tooltip-bottom"
          data-tip="Acceso Admin"
        >
          <div class="indicator">
            <Icon name="material-symbols:lock-person" size={24} />
          </div>
        </a>
      )
    }

    {/* Botón de Tema (Mantenemos el original) */}
    <button
      class="btn btn-ghost btn-circle"
      data-toggle-theme="light,dark"
      data-act-class="ACTIVECLASS"
    >
      <Icon name="material-symbols:contrast" size={24} />
    </button>
  </div>
</header>

<script>
  const header = document.getElementById("site-header");
  const toggleShadow = () => {
    if (!header) return;
    const scrolled = window.scrollY > 4;
    header.classList.toggle("shadow-md", scrolled);
    header.classList.toggle("shadow-none", !scrolled);
  };

  toggleShadow();
  window.addEventListener("scroll", toggleShadow, { passive: true });
</script>
