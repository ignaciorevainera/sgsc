---
import { Icon } from "astro-icon/components";
import { createAstroSupabase } from "@/lib/supabase"; // 1. Importamos el cliente

const { match } = Astro.props;

// 2. Verificamos si hay un usuario logueado
const supabase = createAstroSupabase(Astro);
const {
  data: { session },
} = await supabase.auth.getSession();
const isLoggedIn = !!session; // True si hay usuario, False si es anónimo

// Función para formatear la fecha
const formatDate = (dateString: string) => {
  if (!dateString) return "";
  const date = new Date(dateString + "T00:00:00");
  return date.toLocaleDateString("es-AR", {
    weekday: "short",
    day: "numeric",
    month: "short",
  });
};

// Traducciones y lógica de ganadores
const resultLabels: Record<string, string> = {
  light: "Ganó Equipo Claro",
  dark: "Ganó Equipo Oscuro",
  draw: "Empate",
};

const isLightWinner = match.result === "light";
const isDarkWinner = match.result === "dark";
const isDraw = match.result === "draw";

// Filtramos y ordenamos los equipos
const lightTeam =
  match.match_players?.filter((mp: any) => mp.team === "light") || [];
const darkTeam =
  match.match_players?.filter((mp: any) => mp.team === "dark") || [];

const sortedLightTeam = [...lightTeam].sort((a: any, b: any) =>
  (a.players?.nickname || "")
    .toLowerCase()
    .localeCompare((b.players?.nickname || "").toLowerCase())
);
const sortedDarkTeam = [...darkTeam].sort((a: any, b: any) =>
  (a.players?.nickname || "")
    .toLowerCase()
    .localeCompare((b.players?.nickname || "").toLowerCase())
);
---

<div
  class="card bg-base-100 border-base-200 h-full rounded-xl border shadow-md"
>
  <div class="card-body gap-4">
    {/* Cabecera: Fecha y Cancha */}
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <Icon
          name="material-symbols:calendar-today"
          size={18}
          class="text-primary"
        />
        <span class="text-sm font-semibold sm:text-base"
          >{formatDate(match.date)}</span
        >
      </div>
      <div class="flex flex-row-reverse items-center gap-2 overflow-hidden">
        <Icon
          name="material-symbols:location-on"
          size={18}
          class="text-secondary"
        />
        <span class="truncate text-sm font-semibold sm:text-base">
          {match.fields?.name || "Cancha Desconocida"}
        </span>
      </div>
    </div>

    {/* Fila de Resultado, Video y Editar */}
    <div class="flex flex-col items-center justify-center gap-2 lg:flex-row">
      <span
        class={`badge badge-lg rounded-xl font-bold h-9 px-4 whitespace-nowrap ${
          isDraw
            ? "badge-warning"
            : isLightWinner
              ? "bg-white text-black border border-gray-200 shadow-sm"
              : "bg-black text-white"
        }`}
      >
        {resultLabels[match.result] || match.result}
      </span>

      <div class="flex items-center gap-2">
        {
          match.video_url && (
            <a
              href={match.video_url}
              target="_blank"
              rel="noopener noreferrer"
              class="bg-primary/90 hover:bg-primary group flex h-9 items-center gap-2 rounded-xl px-4 py-1.5 text-[10px] font-black tracking-wider text-white uppercase shadow-md transition-all hover:scale-105 active:scale-95"
            >
              <Icon
                name="material-symbols:play-circle"
                size={18}
                class="shrink-0 animate-pulse group-hover:animate-none"
              />
              <span>Ver Video</span>
            </a>
          )
        }

        {/* Botón Editar (Solo visible para admins) */}
        {
          isLoggedIn && (
            <a
              href={`/admin/matches/edit/${match.id}`}
              class="bg-base-300 hover:bg-base-content/20 group text-base-content flex h-9 items-center gap-2 rounded-xl px-4 py-1.5 text-[10px] font-black tracking-wider uppercase shadow-md transition-all hover:scale-105 active:scale-95"
              title="Editar Partido"
            >
              <Icon name="material-symbols:edit-square-outline" size={18} />
            </a>
          )
        }
      </div>
    </div>

    {/* Equipos */}
    <div class="flex flex-1 flex-col gap-3">
      {/* Equipo Claro */}
      <div
        class={`flex-1 rounded-xl border-2 p-4 bg-white text-gray-900 ${isLightWinner ? "outline-success outline-4" : isDraw ? "border-warning" : "border-gray-300"}`}
      >
        <h3 class="mb-3 text-lg font-black tracking-tight text-gray-900">
          Equipo Claro
        </h3>
        <div class="flex flex-wrap gap-2">
          {
            sortedLightTeam.map((mp: any) => (
              <span class="rounded-xl border border-gray-300 bg-gray-100 px-3 py-1 text-xs font-medium text-gray-900">
                {mp.players?.nickname || "Jugador"}
              </span>
            ))
          }
        </div>
      </div>

      {/* Equipo Oscuro */}
      <div
        class={`flex-1 rounded-xl border-2 bg-slate-800 text-slate-100 p-4 ${isDarkWinner ? "outline-success outline-4" : isDraw ? "border-warning" : "border-slate-700"}`}
      >
        <h3 class="mb-3 text-lg font-black tracking-tight text-slate-100">
          Equipo Oscuro
        </h3>
        <div class="flex flex-wrap gap-2">
          {
            sortedDarkTeam.map((mp: any) => (
              <span class="rounded-xl border border-slate-700 bg-slate-700 px-3 py-1 text-xs font-medium text-slate-100">
                {mp.players?.nickname || "Jugador"}
              </span>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</div>
