---
import { Icon } from "astro-icon/components";
import { createAstroSupabase } from "@/lib/supabase";
import { formatDate } from "@/lib/utils/dateUtils";
import PlayerBadge from "@/components/PlayerBadge.astro";

const { match } = Astro.props;

// 2. Verificamos si hay un usuario logueado
const supabase = createAstroSupabase(Astro);
const {
  data: { session },
} = await supabase.auth.getSession();
const isLoggedIn = !!session; // True si hay usuario, False si es anónimo

// Formato compartido: "Lun, 11 Abr"

// Lógica de ganadores
const isLightWinner = match.result === "light";
const isDarkWinner = match.result === "dark";
const isDraw = match.result === "draw";

// Filtramos y ordenamos los equipos
const lightTeam =
  match.match_players?.filter((mp: any) => mp.team === "light") || [];
const darkTeam =
  match.match_players?.filter((mp: any) => mp.team === "dark") || [];

const sortedLightTeam = [...lightTeam].sort((a: any, b: any) =>
  (a.players?.nickname || "")
    .toLowerCase()
    .localeCompare((b.players?.nickname || "").toLowerCase())
);
const sortedDarkTeam = [...darkTeam].sort((a: any, b: any) =>
  (a.players?.nickname || "")
    .toLowerCase()
    .localeCompare((b.players?.nickname || "").toLowerCase())
);
---

<div class="card bg-base-100 border-base-200 rounded-xl border shadow-md">
  <div class="card-body gap-3">
    {/* Cabecera: Fecha y Cancha */}
    <div class="flex items-center justify-between text-xs sm:text-sm">
      <div class="flex items-center gap-1.5">
        <Icon
          name="material-symbols:calendar-today"
          size={16}
          class="text-primary shrink-0"
        />
        <span class="font-medium">{formatDate(match.date, "long")}</span>
      </div>
      <div class="flex flex-row-reverse items-center gap-1.5 overflow-hidden">
        <Icon
          name="material-symbols:location-on"
          size={16}
          class="text-secondary shrink-0"
        />
        <span class="truncate font-medium">
          {match.fields?.name || "Cancha Desconocida"}
        </span>
      </div>
    </div>

    {/* Badge de resultado */}
    <div class="flex justify-center">
      <span
        class={`badge badge-lg py-4 w-full rounded-xl text-sm font-bold uppercase tracking-wide ${
          isDraw
            ? "border-2 border-yellow-400 bg-yellow-100 text-yellow-700"
            : isLightWinner
              ? "border-2 border-slate-300 bg-slate-100 text-slate-700"
              : "border-2 border-slate-700 bg-slate-800 text-slate-100"
        }`}
      >
        {
          isDraw
            ? "Empate"
            : isLightWinner
              ? "Ganó Equipo Claro"
              : "Ganó Equipo Oscuro"
        }
      </span>
    </div>

    {/* Equipos */}
    <div class="grid flex-1 grid-rows-2 gap-3 sm:grid-cols-2 sm:grid-rows-1">
      {/* Equipo Claro */}
      <div
        class={`relative overflow-hidden rounded-xl border-2 p-3 bg-slate-100 text-slate-800 ${isDraw ? "border-yellow-400" : "border-slate-300"} ${isLightWinner ? "ring-2 ring-emerald-400 ring-offset-2 ring-offset-base-100" : ""}`}
      >
        <h3 class="sr-only">Equipo Claro</h3>
        <div class="relative z-10 flex flex-wrap gap-1.5">
          {
            sortedLightTeam.map((mp: any) => (
              <PlayerBadge
                nickname={mp.players?.nickname || "Jugador"}
                team="light"
              />
            ))
          }
        </div>
        <Icon
          name="material-symbols:wb-sunny"
          class="pointer-events-none absolute -right-4 -bottom-4 h-20 w-20 rotate-12 text-slate-300/40"
        />
      </div>

      {/* Equipo Oscuro */}
      <div
        class={`relative overflow-hidden rounded-xl border-2 bg-slate-800 text-slate-100 p-3 ${isDraw ? "border-yellow-400" : "border-slate-700"} ${isDarkWinner ? "ring-2 ring-emerald-400 ring-offset-2 ring-offset-slate-800" : ""}`}
      >
        <h3 class="sr-only">Equipo Oscuro</h3>
        <div class="relative z-10 flex flex-wrap gap-1.5">
          {
            sortedDarkTeam.map((mp: any) => (
              <PlayerBadge
                nickname={mp.players?.nickname || "Jugador"}
                team="dark"
              />
            ))
          }
        </div>
        <Icon
          name="material-symbols:dark-mode"
          class="pointer-events-none absolute -right-4 -bottom-4 h-20 w-20 -rotate-12 text-slate-700/50"
        />
      </div>
    </div>

    {/* Footer: Botón de Video */}
    {
      match.video_url && (
        <div class="card-actions justify-end">
          <a
            href={match.video_url}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-primary btn-sm rounded-xl font-bold uppercase"
          >
            <Icon
              name="material-symbols:play-circle"
              size={18}
              class="shrink-0 animate-pulse"
            />
            <span>Ver Video</span>
          </a>
        </div>
      )
    }
  </div>
</div>
